# ğŸ“ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì™„ì „ ê°€ì´ë“œ

## âš ï¸ ì¤‘ìš”: ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”!

---

## 1ï¸âƒ£ SQL ì‹¤í–‰ (í•„ìˆ˜!)

### Step 1: attachments í…Œì´ë¸” ìƒì„±
```
íŒŒì¼: supabase/migrations/0009_attachments_table.sql
â†’ Supabase Dashboard â†’ SQL Editor â†’ ì‹¤í–‰
```

### Step 2: RLS ì¬ê·€ ë¬¸ì œ í•´ê²°
```
íŒŒì¼: supabase/migrations/0011_fix_users_rls_recursion.sql
â†’ Supabase Dashboard â†’ SQL Editor â†’ ì‹¤í–‰
```

### Step 3: Storage Policies ì„¤ì • (ê°„ë‹¨í•œ ë²„ì „)
```
íŒŒì¼: supabase/migrations/0013_storage_policies_simple.sql
â†’ Supabase Dashboard â†’ SQL Editor â†’ ì‹¤í–‰
â†’ ë§ˆì§€ë§‰ SELECT ì¿¼ë¦¬ ê²°ê³¼ í™•ì¸ (3ê°œ ì •ì±… ìƒì„± í™•ì¸)
```

**í™•ì¸ ë°©ë²•:**
```sql
SELECT policyname, cmd 
FROM pg_policies 
WHERE schemaname = 'storage' 
AND tablename = 'objects'
AND policyname LIKE '%ë³´í˜¸ìëŠ”%';
```
â†’ 3ê°œ ì •ì±…ì´ ë‚˜ì™€ì•¼ í•¨ (INSERT, SELECT, DELETE)

---

## 2ï¸âƒ£ Storage Bucket ìƒì„± (í•„ìˆ˜!)

### Supabase Dashboardì—ì„œ:

1. **Storage** ë©”ë‰´ í´ë¦­
2. **[New bucket]** ë²„íŠ¼ í´ë¦­
3. ì„¤ì •:
   - **Name**: `attachments` (ì •í™•íˆ ì´ ì´ë¦„!)
   - **Public bucket**: âœ“ **ì²´í¬ í•„ìˆ˜!**
4. **[Create bucket]** í´ë¦­

### í™•ì¸:
```sql
SELECT name, id, public 
FROM storage.buckets 
WHERE name = 'attachments';
```
â†’ 1ê°œ í–‰ì´ ë‚˜ì™€ì•¼ í•¨, `public = true` í™•ì¸

---

## 3ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë°©ë²•

### ë¸Œë¼ìš°ì € ì½˜ì†” í™•ì¸
1. ê°œë°œì ë„êµ¬ ì—´ê¸° (F12)
2. **Console** íƒ­
3. íŒŒì¼ ì—…ë¡œë“œ ì‹œë„
4. ë¡œê·¸ í™•ì¸:
   - `ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘:` - ì—…ë¡œë“œ ì‹œì‘ë¨
   - `âœ… Storage ì—…ë¡œë“œ ì„±ê³µ:` - ì„±ê³µ!
   - `âŒ Storage ì—…ë¡œë“œ ì˜¤ë¥˜:` - ì—ëŸ¬ ë°œìƒ

### ì—ëŸ¬ë³„ í•´ê²° ë°©ë²•

#### ì—ëŸ¬ 1: "Bucket not found"
```
ì›ì¸: Storage bucketì´ ìƒì„±ë˜ì§€ ì•ŠìŒ
í•´ê²°: 2ï¸âƒ£ Storage Bucket ìƒì„± ë‹¤ì‹œ í™•ì¸
```

#### ì—ëŸ¬ 2: "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" / "permission denied" / 403
```
ì›ì¸: Storage RLS ì •ì±…ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ
í•´ê²°: 
1. 0013_storage_policies_simple.sql ì‹¤í–‰ í™•ì¸
2. ì •ì±… í™•ì¸ ì¿¼ë¦¬ ì‹¤í–‰ (3ê°œ ì •ì±… í™•ì¸)
3. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
```

#### ì—ëŸ¬ 3: "ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤" / 409
```
ì›ì¸: ë™ì¼í•œ íŒŒì¼ëª…ì´ ì´ë¯¸ ì¡´ì¬
í•´ê²°: ë‹¤ë¥¸ íŒŒì¼ëª…ìœ¼ë¡œ ì—…ë¡œë“œ (ìë™ìœ¼ë¡œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ë¨)
```

---

## 4ï¸âƒ£ íŒŒì¼ ì—…ë¡œë“œ í”Œë¡œìš°

```
1. ì‚¬ìš©ìê°€ íŒŒì¼ ì„ íƒ
   â†“
2. íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ (í™•ì¥ì, í¬ê¸°)
   â†“
3. getUploadPath() í˜¸ì¶œ (ì„œë²„ ì•¡ì…˜)
   â†’ ê²½ë¡œ ìƒì„±: {case_id}/{timestamp}_{filename}
   â†“
4. Storageì— ì§ì ‘ ì—…ë¡œë“œ (í´ë¼ì´ì–¸íŠ¸)
   â†’ supabase.storage.from("attachments").upload()
   â†“
5. ë©”íƒ€ë°ì´í„° ì €ì¥ (ì„œë²„ ì•¡ì…˜)
   â†’ saveAttachmentMetadata()
   â†“
6. ëª©ë¡ ìƒˆë¡œê³ ì¹¨
```

---

## 5ï¸âƒ£ ë¬¸ì œ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸

### SQL ì‹¤í–‰ í™•ì¸
- [ ] 0009_attachments_table.sql ì‹¤í–‰ ì™„ë£Œ
- [ ] 0011_fix_users_rls_recursion.sql ì‹¤í–‰ ì™„ë£Œ
- [ ] 0013_storage_policies_simple.sql ì‹¤í–‰ ì™„ë£Œ
- [ ] ì •ì±… í™•ì¸ ì¿¼ë¦¬ â†’ 3ê°œ ì •ì±… í™•ì¸

### Storage Bucket í™•ì¸
- [ ] `attachments` bucket ìƒì„±ë¨
- [ ] Public bucket: âœ“ (ì²´í¬ë¨)
- [ ] SQLë¡œ í™•ì¸: `SELECT * FROM storage.buckets WHERE name = 'attachments'`

### ì½”ë“œ í™•ì¸
- [ ] ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
- [ ] ì¼€ì´ìŠ¤ ID í™•ì¸
- [ ] ë¸Œë¼ìš°ì € ì½˜ì†” ì—ëŸ¬ í™•ì¸

### í™˜ê²½ ë³€ìˆ˜ í™•ì¸
- [ ] `.env.local`ì— `NEXT_PUBLIC_SUPABASE_URL` ìˆìŒ
- [ ] `.env.local`ì— `NEXT_PUBLIC_SUPABASE_ANON_KEY` ìˆìŒ
- [ ] ì„œë²„ ì¬ì‹œì‘ (`npm run dev`)

---

## 6ï¸âƒ£ ë””ë²„ê¹… íŒ

### ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ í™•ì¸:
```javascript
// Supabase í´ë¼ì´ì–¸íŠ¸ í™•ì¸
import { createClient } from '@/modules/shared/lib/supabase/client';
const supabase = createClient();

// Storage bucket í™•ì¸
const { data, error } = await supabase.storage.listBuckets();
console.log('Buckets:', data);

// attachments bucket í™•ì¸
const { data: files, error: listError } = await supabase.storage
  .from('attachments')
  .list();
console.log('Files:', files);
```

### Network íƒ­ì—ì„œ í™•ì¸:
1. ê°œë°œì ë„êµ¬ â†’ **Network** íƒ­
2. íŒŒì¼ ì—…ë¡œë“œ ì‹œë„
3. `storage/v1/object/attachments/...` ìš”ì²­ í™•ì¸
4. Status Code í™•ì¸:
   - `200`: ì„±ê³µ
   - `403`: ê¶Œí•œ ì—†ìŒ (RLS ì •ì±… í™•ì¸)
   - `404`: Bucket ì—†ìŒ

---

## 7ï¸âƒ£ ì™„ë£Œ í™•ì¸

### ì„±ê³µ ì‹œ:
- âœ… "âœ… íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!" ë©”ì‹œì§€
- âœ… íŒŒì¼ ëª©ë¡ì— í‘œì‹œë¨
- âœ… ë¸Œë¼ìš°ì € ì½˜ì†”ì— "âœ… Storage ì—…ë¡œë“œ ì„±ê³µ" ë¡œê·¸
- âœ… [ë³´ê¸°] ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì—´ë¦¼

---

**ì‘ì„±ì¼**: 2025-12-08  
**ë²„ì „**: 2.0 (ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ë²„ì „)

