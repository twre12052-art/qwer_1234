%% 1. 전체 유저 흐름 (보호자 + 간병인)

flowchart TD

  %% 보호자 플로우
  subgraph Guardian[보호자 플로우]
    G1[로그인 / 회원가입<br/>/login] --> G2[내 케이스 목록<br/>/cases]

    G2 --> G3[새 간병 등록<br/>/cases/new]
    G3 --> G4[간병인 링크 확인/복사<br/>케이스 생성 완료]

    G2 --> G5[케이스 상세 보기<br/>/cases/:id]
    G5 --> G6[간병 조기 종료 / 연장<br/>end_date 변경]
    G5 --> G7[간병비 지급 정보 입력<br/>/cases/:id/payment]
    G5 --> G8[PDF 서류 만들기<br/>generatePdf]
  end

  %% 간병인 플로우
  subgraph Caregiver[간병인 플로우]
    C1[보호자에게서<br/>링크 수신] --> C2[링크 접속<br/>/caregiver/:token]

    C2 --> C3[간병 내용 확인 +<br/>간병인 정보 입력]
    C3 --> C4[동의하기 클릭<br/>caregiver_agreed_at 저장]

    C4 --> C5[간병일지 홈<br/>/caregiver/:token/logs]
    C5 --> C6[오늘 일지 작성 화면<br/>/caregiver/:token/logs/:date]
    C6 --> C7[체크·메모 작성 후 저장<br/>care_logs 생성/수정]
    C7 --> C5
  end

  %% 보호자 ↔ 간병인 연결
  G4 -- 카카오톡 등으로 링크 공유 --> C1

  %% 케이스 상태 변화 개념
  G3 -. cases.status: GUARDIAN_PENDING .-> C2
  C4 -. cases.status: IN_PROGRESS .-> G5
  G6 -. 조기 종료/연장 .-> C5
  G8 -. PDF 완료 .-> G2

%% 2. 시스템 & 데이터 흐름 (브라우저 ↔ Next.js ↔ Supabase)

flowchart LR

  subgraph Client[브라우저(웹)]
    U1[보호자 화면<br/>/login, /cases...] 
    U2[간병인 화면<br/>/caregiver/:token...]
  end

  subgraph App[Next.js 앱<br/>(App Router + Server Actions)]
    A1[Auth 모듈<br/>modules/auth/actions.ts]
    A2[Case 모듈<br/>modules/case/actions.ts]
    A3[CareLog 모듈<br/>modules/careLog/actions.ts]
    A4[PDF 모듈<br/>modules/pdf/actions.ts]
  end

  subgraph DB[Supabase<br/>(PostgreSQL + Auth + Storage)]
    D1[(users)]
    D2[(cases)]
    D3[(care_logs)]
    D4[(payments)]
    D5[(case_tokens)]
  end

  %% 브라우저 -> Next.js
  U1 -->|로그인/회원가입| A1
  A1 --> D1

  U1 -->|새 케이스 생성| A2
  A2 --> D2
  A2 --> D5

  U2 -->|토큰으로 접속| A2
  A2 --> D5
  A2 --> D2

  U2 -->|일지 작성| A3
  A3 --> D3

  U1 -->|조기 종료/연장| A2
  A2 --> D2
  A2 --> D3

  U1 -->|지급정보 입력| A2
  A2 --> D4

  U1 -->|PDF 생성| A4
  A4 --> D2
  A4 --> D3
  A4 --> D4
  A4 -->|PDF 바이너리 응답| U1
%% 3. 데이터 모델 구조 (테이블 관계)

classDiagram
  direction LR

  class users {
    UUID id
    string email
    string name
    string phone
    string address
    date   birth_date
    string role  // guardian | caregiver | admin
    timestamptz created_at
    timestamptz updated_at
  }

  class cases {
    UUID id
    UUID guardian_id

    string patient_name
    string hospital_name

    date   start_date
    date   end_date_planned
    date   end_date_final

    int    daily_rate

    string caregiver_name
    string caregiver_phone
    string caregiver_address
    string caregiver_rrn_raw   // 1차 개발용, 추후 암호화/축소
    string caregiver_bank
    string caregiver_account
    timestamptz caregiver_agreed_at

    string status  // GUARDIAN_PENDING, IN_PROGRESS, DONE ...

    timestamptz created_at
    timestamptz updated_at
  }

  class care_logs {
    UUID id
    UUID case_id

    date   date      // 간병 날짜
    bool   had_meal
    bool   turned_position
    bool   took_medicine
    bool   moved
    bool   toilet_help
    string memo

    bool   is_active

    timestamptz created_at
    timestamptz updated_at
  }

  class payments {
    UUID id
    UUID case_id
    int  total_days
    int  total_amount
    timestamptz paid_at
    string payment_method  // transfer | cash ...
    timestamptz created_at
    timestamptz updated_at
  }

  class case_tokens {
    UUID id
    UUID case_id
    string token
    timestamptz expires_at
    timestamptz used_at
    timestamptz created_at
    timestamptz updated_at
  }

  %% 관계
  users "1" --> "many" cases : guardian
  cases "1" --> "many" care_logs : logs
  cases "1" --> "0..1" payments : payment
  cases "1" --> "0..many" case_tokens : tokens
%% 4. 대표 시나리오 시퀀스 (케이스 생성 → 간병인 동의 → 일지 → PDF)

sequenceDiagram
  participant G as 보호자 브라우저
  participant C as 간병인 브라우저
  participant N as Next.js(Server Actions)
  participant S as Supabase(DB)

  %% 1. 보호자 케이스 생성
  G->>N: createCase(환자/기간/비용/간병인 연락처)
  N->>S: INSERT cases, case_tokens
  S-->>N: 새 case, token 반환
  N-->>G: 케이스 생성 완료 + 간병인 링크

  %% 2. 간병인 동의
  C->>N: GET /caregiver/:token
  N->>S: SELECT case_tokens + cases by token
  S-->>N: 케이스 정보
  N-->>C: 간병 내용 표시

  C->>N: caregiverAgree(이름/주민번호/주소/계좌)
  N->>S: UPDATE cases (간병인 정보, 상태 IN_PROGRESS)
  S-->>N: OK
  N-->>C: 간병일지 홈으로 이동

  %% 3. 일지 작성
  C->>N: createDailyLog(날짜, 체크/메모)
  N->>S: INSERT/UPDATE care_logs
  S-->>N: OK
  N-->>C: 일지 저장 완료

  %% 4. 보호자 지급정보 + PDF
  G->>N: savePayment(총일수/금액/지급일/방식)
  N->>S: INSERT/UPDATE payments
  S-->>N: OK

  G->>N: generatePdf(caseId)
  N->>S: SELECT case, care_logs, payments
  S-->>N: 데이터 반환
  N-->>G: PDF 파일 다운로드


