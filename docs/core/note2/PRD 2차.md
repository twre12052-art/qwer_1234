# 📌 간병노트 2차 PRD (최종본)

## 1. 문서 개요

- 이름: 간병노트 2차 고도화 PRD
- 버전: v2.0
- 목적:
  - 1차에서 구현된 **계약/일지/PDF** 기능 위에,
  - **운영 안정성(권한/날짜/로그), 휴대폰 문자 인증, 카카오 알림, 서류 이메일 제출**을 완성한다.

---

## 2. 사용자별 기능 요구사항

### 2.1 보호자 (Guardian)

#### 2.1.1 가입/로그인

- 입력 항목:
  - 이름
  - 생년월일
  - 이메일 주소
  - 휴대폰 번호
- 흐름:
  1. 휴대폰 번호 입력 후 **[인증번호 받기]** 클릭
  2. 문자로 전달된 6자리 인증번호 입력 후 **[인증 확인]**
  3. 인증 성공 시 계정 생성 + 로그인 완료
  4. 재로그인 시에는 휴대폰 번호 + 문자 인증만으로 로그인 가능

#### 2.1.2 케이스 관리

- `/cases`:
  - 로그인한 보호자의 케이스만 카드형으로 표시
  - “[새 간병 케이스 만들기]” 버튼 제공
- 케이스 생성:
  - 필수 필드: 환자 이름, 병원명, 예상 시작일, 예상 종료일
  - **과거 날짜는 선택 불가**
- 케이스 상세(`/cases/[id]`):
  - 기본 정보: 환자/병원/기간/상태
  - 기능:
    - [간병인 링크 복사]
    - [연장 요청], [조기 종료 요청]
  - 규칙:
    - 연장/조기 종료는 **미래 날짜만 선택 가능**

#### 2.1.3 서류 발급 및 이메일 전송

- 종료 상태의 케이스:
  - [서류 발급하기] 버튼 노출
- 서류 종류:
  - 간병 계약서
  - 간병일지 요약
  - 수령/지급 확인서 (필요 시)
- 서류 발급 방식:
  - PDF로 묶어서 생성
  - 보호자가 이메일 주소 입력 후 [이메일로 받기]
    - 기본값: 가입 시 입력한 이메일
- 결과:
  - 선택한 이메일 주소로 PDF 첨부 메일 전송

---

### 2.2 간병인 (Caregiver)

#### 2.2.1 접속 및 본인 확인

- 진입:
  - 보호자 또는 운영자가 전달한 `/caregiver/[token]` 링크
- 접속 후 화면:
  - 간단한 케이스 정보(환자명, 병원, 기간) 요약
  - 휴대폰 번호 입력 + 6자리 문자 인증
  - 링크에 지정된 간병인 전화번호와 불일치 시 접근 불가

#### 2.2.2 계약 확인 및 일지 작성

- 계약 화면:
  - 주요 계약 항목 요약
  - [내용 확인 및 동의] 체크/버튼
- 일지 작성 화면:
  - 오늘 날짜 자동 선택
  - 간단 체크리스트 + 자유 메모
  - 규칙:
    - **오늘 날짜만 작성 가능**
    - 과거 날짜 선택/작성 불가
    - 케이스가 종료되면 작성 불가

---

### 2.3 운영자 (Admin)

#### 2.3.1 어드민 대시보드

- URL: `/admin/cases`
- 기능:
  - 전체 케이스 목록 테이블
  - 검색:
    - 보호자 이름
    - 환자 이름
    - 병원명
    - 전화번호 일부
  - 필터:
    - 상태(진행중/종료/조기 종료/취소)
    - 기간(시작일 기준)

#### 2.3.2 케이스 상세 관리

- URL: `/admin/cases/[id]`
- 정보:
  - 보호자 정보, 환자 정보, 병원, 기간, 상태, 간병인 링크 여부
- 기능:
  - [강제 종료]
  - [기간 수정] (과거/미래 모두 허용)
  - [간병인 링크 재발송] (카카오 알림톡)
- 로그 탭:
  - `activity_logs` 내용 시간순 표시
  - 액션 종류(생성, 종료, 강제 종료, 기간 변경 등), 실행자, 변경 전/후 값
- 알림/이메일 이력 탭:
  - `notification_logs` 에 기록된
    - 카카오 알림톡 발송 결과
    - 이메일(PDF) 발송 결과
  - 실패 건에 대해 [재발송] 버튼 제공

---

## 3. 케이스 상태 및 전이 규칙

### 3.1 케이스 상태 값

- `pending` : 케이스 생성 완료, 아직 간병 시작 전
- `active` : 간병 진행 중
- `ended` : 계획한 종료일에 맞춰 정상 종료
- `ended_early` : 조기 종료
- `canceled` : 시작 전 취소

### 3.2 상태 전환 규칙 (예시)

- `pending → active`
  - 시작일이 오늘이 되면 자동 또는 운영자 수동 변경
- `active → ended`
  - 종료 예정일이 지나면 pg_cron으로 자동 변경
- `active → ended_early`
  - 보호자 요청 + 운영자 확인 후 운영자가 변경
- `pending → canceled`
  - 시작일 이전에 보호자 또는 운영자가 취소

---

## 4. 비즈니스 규칙 (공통)

1. 보호자/간병인 화면:
   - 과거 날짜 선택/입력 불가
2. 운영자 화면:
   - 과거 날짜 포함 기간 수정 가능
3. 간병 종료 후:
   - 보호자 화면에서만 서류 발급 가능
4. 문자/알림/이메일:
   - 문자: **휴대폰 인증번호(6자리)** 발송에만 사용
   - 카카오 알림톡: 시작/종료/링크 안내/리마인드 등 모든 알림
   - 이메일: PDF 서류를 받거나 제출할 때만 사용

---

## 5. 예외/에러 처리 (2차 기준)

- 휴대폰 인증번호 발송 실패:
  - 사용자에게 “문자 발송에 실패했습니다. 다시 시도해주세요.” 안내
- 인증번호 불일치/만료:
  - “인증번호가 올바르지 않거나 만료되었습니다.” 안내
- 카카오 알림톡 발송 실패:
  - `notification_logs`에 실패 기록
  - 운영자 화면에서 재발송 가능
- 이메일 전송 실패:
  - 사용자에게 “이메일 전송에 실패했습니다. 이메일 주소를 확인 후 다시 시도해주세요.” 안내
  - 실패 내역은 `notification_logs`에 기록

---

## 6. 데이터/개인정보 관련 (2차 기준)

- 수집 항목:
  - 이름, 생년월일, 이메일, 전화번호, 간병 관련 정보
- 미수집:
  - 주민등록번호, 계좌번호 등 고위험 민감정보
- 로그:
  - 중요한 상태 변경, 알림/이메일 발송은 로그 테이블에 기록
- **데이터 보관/익명화의 상세 정책(보관 기간, 익명화 방법 등)은 3차에서 설계·반영**
