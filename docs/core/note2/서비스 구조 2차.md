# 🧱 간병노트 2차 서비스 구조 (최종본)

## 1. 전체 아키텍처 개요

- 클라이언트:
  - 보호자, 간병인, 운영자 → 브라우저에서 접속
- Next.js 앱:
  - 페이지(화면)
  - API(Route Handlers)
  - 도메인 모듈(auth, cases, careLogs, documents, notification)
- Supabase:
  - Postgres DB + Auth + RLS + pg_cron
- Solapi:
  - SMS(휴대폰 인증번호 전용)
  - Kakao 알림톡(서비스 알림 전용)
- Gmail:
  - PDF 서류 이메일 전송

---

## 2. 라우트 구조

### 2.1 보호자

- `/auth/phone` (또는 모달)
  - 휴대폰 번호 + 인증번호 입력 화면
- `/cases`
  - 내 케이스 목록
  - “[새 간병 케이스 만들기]” 버튼
- `/cases/[id]`
  - 케이스 상세: 환자/병원/기간/상태
  - [간병인 링크 복사], [연장 요청], [조기 종료 요청], [서류 발급하기]
- `/cases/[id]/documents` (또는 상세 내 서류 섹션)
  - 서류 종류 선택, 이메일 주소 입력, [이메일로 받기]

### 2.2 간병인

- `/caregiver/[token]`
  - 링크 접속 → 휴대폰 인증 → 계약 내용 확인 및 동의
  - 오늘 날짜 기준 일지 작성 화면

### 2.3 운영자

- `/admin/cases`
  - 전체 케이스 테이블
  - 검색(보호자/환자/병원/전화번호), 상태/기간 필터
- `/admin/cases/[id]`
  - 케이스 상세 정보
  - [강제 종료], [기간 수정], [링크 재발송] 버튼
  - 로그 탭: 상태 변경/조작 이력
  - 알림/이메일 이력 탭: 카카오 알림·이메일 발송 기록 및 재발송

---

## 3. 데이터 흐름 (요약)

### 3.1 가입/로그인 흐름

1. 보호자/간병인:
   - 이름/생년월일/이메일/전화번호 입력(보호자 기준)
   - 휴대폰 번호로 인증번호(6자리) 문자 수신
   - 인증번호 입력 → 서버에서 확인 후 세션 발급
2. Supabase:
   - 내부적으로 `휴대폰번호@care.local` 로 Auth 계정 관리
   - `users` 테이블에 프로필/역할 정보 저장

### 3.2 케이스 흐름

1. 보호자가 `/cases` 에서 케이스 생성
   - 환자/병원/기간(과거 금지) → `cases` 테이블에 저장
   - 상태: 기본 `pending`
2. 간병 시작 시점 또는 날짜가 도래하면 `active`
3. 종료일이 지나면 pg_cron이 `ended`로 자동 변경
4. 조기 종료:
   - 보호자 요청 + 운영자 확인 후 상태 `ended_early`

### 3.3 간병인 링크 & 일지 흐름

1. 보호자가 케이스 상세에서 “간병인 링크 생성”
   - `case_tokens` 에 `(case_id, token_hash, caregiver_phone, expired_at)` 저장
2. 간병인이 링크로 접속 → 휴대폰 문자 인증 완료
3. 인증 완료 후:
   - 계약 내용 확인/동의
   - 오늘 날짜 기준으로 일지 작성 → `care_logs`에 저장

### 3.4 서류/PDF & 이메일 흐름

1. 종료 상태의 케이스에서 보호자가 “서류 발급하기”
2. 서버:
   - `cases`, `care_logs` 데이터를 조회
   - `@react-pdf/renderer` 로 PDF 생성
3. 보호자가 이메일 입력 후 “이메일로 받기”
   - 서버가 Gmail SMTP로 PDF 첨부 메일 발송
   - 결과는 `notification_logs`에 `channel = 'email_submit'` 으로 기록

### 3.5 알림 흐름

- 문자(SMS):
  - 휴대폰 인증번호(6자리) 전송에만 사용
- 카카오 알림톡:
  - 간병 시작일 아침 안내
  - 간병인 링크 안내/재발송
  - 종료/조기 종료 후 서류 발급 안내
  - (선택) 일지 작성 리마인드
- 모든 발송 결과는 `notification_logs`에 기록

---

## 4. 운영자 관점 구조

- **전역 뷰:** `/admin/cases`
  - 어떤 케이스가 언제 시작/종료되는지 한눈에 확인
  - 필터/검색으로 문제 케이스 빠르게 찾아가기
- **케이스 단위 뷰:** `/admin/cases/[id]`
  - 날짜/상태 꼬인 케이스를 강제 정리
  - 간병인 링크 재발송
  - 로그/알림 이력으로 “언제 무슨 일이 있었는지” 추적

---

## 5. 데이터/익명화 (2차 관점)

- 2차에서는:
  - 필요한 최소한의 개인정보만 수집/저장
  - 상태 변경/알림/이메일 발송 이력은 모두 로그로 남김
- **정확한 보관 기간 및 자동 익명화/마스킹 로직은 3차에서 상세 설계 및 구현 예정**
