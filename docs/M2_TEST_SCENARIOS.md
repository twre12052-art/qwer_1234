# 🧪 M2 테스트 시나리오 (보호자 플로우)

## 📋 테스트 개요

**목적**: M2 단계 완료 전 전체 기능과 보안 검증  
**대상**: 보호자 플로우 (WP2.1 ~ WP2.5)  
**방법**: 수동 테스트 (브라우저)

---

## 🔐 테스트 준비

### 1. 테스트 계정 준비
```
계정 A (보호자 1):
- 아이디: testuser1
- 비밀번호: password1234

계정 B (보호자 2):
- 아이디: testuser2
- 비밀번호: password1234
```

### 2. 브라우저 준비
- Chrome 일반 창: 계정 A
- Chrome 시크릿 창: 계정 B

### 3. 테스트 환경
```
http://localhost:3000
개발 서버 실행: npm run dev
```

---

## ✅ Test Suite 1: 케이스 생성 및 조회 (WP2.1, WP2.2)

### Test 1.1: 새 계정의 빈 목록
**Given**: 새로 가입한 계정 (케이스 없음)  
**When**: `/cases` 접속  
**Then**:
- [ ] "아직 생성된 케이스가 없습니다" 메시지 표시
- [ ] [+ 새 간병 등록] 버튼 표시

### Test 1.2: 유효한 케이스 생성
**Given**: 로그인된 상태  
**When**: 새 케이스 생성
```
환자 성함: 홍길동
병원명: 서울병원
진단명: 뇌졸중
시작일: 오늘
종료일: 7일 후
1일 간병비: 150000
간병인 성함: 김간병
연락처: 010-1234-5678
```
**Then**:
- [ ] 케이스 생성 성공
- [ ] 목록 페이지로 리다이렉트
- [ ] 생성한 케이스가 목록에 표시됨
- [ ] 상태: "보호자 동의 대기"

### Test 1.3: 과거 날짜 시작일 (에러 케이스)
**Given**: 케이스 생성 폼  
**When**: 시작일을 어제로 설정  
**Then**:
- [ ] "시작일은 오늘 또는 미래 날짜만 선택 가능합니다" 에러
- [ ] 케이스 생성 안 됨

### Test 1.4: 종료일 < 시작일 (에러 케이스)
**Given**: 케이스 생성 폼  
**When**: 
```
시작일: 2025-12-20
종료일: 2025-12-15
```
**Then**:
- [ ] "종료일은 시작일 이후여야 합니다" 에러
- [ ] 케이스 생성 안 됨

---

## ✅ Test Suite 2: 케이스 상세 조회 (WP2.3)

### Test 2.1: 내 케이스 상세 조회
**Given**: 계정 A가 생성한 케이스  
**When**: 목록에서 케이스 카드 클릭  
**Then**:
- [ ] 케이스 상세 페이지 표시
- [ ] Timeline 표시 ("계약 동의" 단계 활성)
- [ ] 환자 정보 표시
- [ ] 간병 기간 정보 표시
- [ ] [계약서 동의] 버튼 표시
- [ ] [케이스 삭제] 버튼 표시

### Test 2.2: 다른 사용자 케이스 접근 차단 (⭐ 보안)
**Given**: 
- 계정 A: 케이스 생성 (ID 복사)
- 계정 B: 로그인
**When**: 계정 B가 계정 A의 케이스 ID로 직접 접근
```
http://localhost:3000/cases/[A의케이스ID]
```
**Then**:
- [ ] "권한이 없습니다" 메시지 표시
- [ ] 케이스 정보가 보이지 않음

---

## ✅ Test Suite 3: 케이스 삭제 (WP2.5)

### Test 3.1: 삭제 Confirm - 취소
**Given**: 계정 A의 케이스 상세 페이지  
**When**: 
1. [케이스 삭제] 버튼 클릭
2. Confirm 모달 표시됨
3. [취소] 버튼 클릭
**Then**:
- [ ] 모달이 닫힘
- [ ] 케이스가 삭제되지 않음
- [ ] 상세 페이지에 그대로 남아 있음

### Test 3.2: 삭제 Confirm - 삭제 실행
**Given**: 계정 A의 케이스 상세 페이지  
**When**: 
1. [케이스 삭제] 버튼 클릭
2. Confirm 모달 표시됨
3. [정말 삭제하기] 버튼 클릭
**Then**:
- [ ] "삭제 중..." 로딩 표시
- [ ] 목록 페이지로 리다이렉트 (`/cases`)
- [ ] 삭제된 케이스가 목록에서 사라짐

### Test 3.3: CASCADE 삭제 확인 (DB 레벨)
**Given**: 
- 케이스 생성
- 계약 동의 → 간병인 링크 생성 (`case_tokens` 생성됨)
- 간병일지 작성 (`care_logs` 생성됨)
**When**: 케이스 삭제  
**Then**:
- [ ] `cases` 테이블에서 케이스 삭제됨
- [ ] `case_tokens` 테이블에서 관련 토큰 삭제됨
- [ ] `care_logs` 테이블에서 관련 일지 삭제됨

**확인 방법 (Supabase SQL Editor)**:
```sql
-- 삭제 전 확인
SELECT * FROM cases WHERE id = '[케이스ID]';
SELECT * FROM case_tokens WHERE case_id = '[케이스ID]';
SELECT * FROM care_logs WHERE case_id = '[케이스ID]';

-- 삭제 후 확인 (모두 0 rows)
```

---

## ✅ Test Suite 4: 보안 테스트 (⭐ 중요)

### Test 4.1: 목록 조회 - 다른 사용자 케이스 미표시
**Given**: 
- 계정 A: 케이스 2개 생성
- 계정 B: 케이스 1개 생성
**When**: 
- 계정 A로 `/cases` 접속
**Then**:
- [ ] 계정 A의 케이스 2개만 표시
- [ ] 계정 B의 케이스는 보이지 않음

**When**: 
- 계정 B로 `/cases` 접속
**Then**:
- [ ] 계정 B의 케이스 1개만 표시
- [ ] 계정 A의 케이스는 보이지 않음

### Test 4.2: 직접 URL 접근 차단
**Given**: 
- 계정 A의 케이스 ID: `abc123`
- 계정 B로 로그인
**When**: 
```
http://localhost:3000/cases/abc123
```
**Then**:
- [ ] "권한이 없습니다" 메시지
- [ ] 케이스 정보 표시 안 됨

### Test 4.3: 삭제 권한 검증
**Given**: 
- 계정 A의 케이스
- 계정 B로 로그인
**When**: 
- 브라우저 콘솔에서 직접 Server Action 호출 시도
```javascript
// 이건 실패해야 정상
await deleteCase('abc123');
```
**Then**:
- [ ] "권한이 없습니다" 에러
- [ ] 케이스 삭제 안 됨

---

## ✅ Test Suite 5: E2E 전체 보호자 플로우

### Test 5.1: 신규 보호자 전체 플로우
**Given**: 새 계정 가입  
**When**: 아래 단계 수행

#### Step 1: 회원가입 및 로그인
```
1. /signup 접속
2. 회원가입
3. /login 접속
4. 로그인
```
**Then**: [ ] `/cases` 로 리다이렉트

#### Step 2: 케이스 생성
```
1. [+ 새 간병 등록] 클릭
2. 정보 입력
3. [저장] 클릭
```
**Then**: 
- [ ] 케이스 생성 성공
- [ ] 목록에 표시

#### Step 3: 계약 동의
```
1. 케이스 클릭
2. [계약서 동의] 클릭
3. 체크박스 동의
4. [동의하고 계속] 클릭
```
**Then**:
- [ ] 상태: "간병인 연결 대기"
- [ ] 간병인 초대 링크 표시

#### Step 4: 간병인 링크 전달
```
1. 간병인 링크 복사
2. 시크릿 창에서 링크 접속
3. 간병인 정보 입력 및 동의
```
**Then**:
- [ ] 상태: "진행 중"
- [ ] Timeline 업데이트

#### Step 5: 간병일지 확인
```
1. 간병인: 일지 작성
2. 보호자: 케이스 상세에서 일지 확인
```
**Then**:
- [ ] 작성된 일지 표시

#### Step 6: 서류 생성
```
1. [서류 생성] 버튼 클릭
2. PDF 다운로드
```
**Then**:
- [ ] PDF 파일 생성
- [ ] 한글 정상 표시

#### Step 7: 케이스 삭제
```
1. [케이스 삭제] 클릭
2. Confirm 확인
3. [정말 삭제하기] 클릭
```
**Then**:
- [ ] 목록으로 이동
- [ ] 케이스 사라짐

---

## 📊 테스트 결과 기록

### 테스트 실행 정보
- **실행일**: ____________
- **실행자**: ____________
- **브라우저**: Chrome / Firefox / Safari
- **환경**: Development / Staging

### 결과 요약
| Test Suite | 통과 | 실패 | 비고 |
|------------|------|------|------|
| Suite 1: 케이스 생성/조회 | __/4 | __/4 | |
| Suite 2: 케이스 상세 | __/2 | __/2 | |
| Suite 3: 케이스 삭제 | __/3 | __/3 | |
| Suite 4: 보안 테스트 | __/3 | __/3 | |
| Suite 5: E2E 플로우 | __/7 | __/7 | |
| **Total** | __/19 | __/19 | |

### 발견된 이슈
1. ____________________________________________
2. ____________________________________________
3. ____________________________________________

---

## ✅ 완료 조건

다음 모든 항목이 체크되면 M2 완료:
- [ ] Test Suite 1-5 모두 통과
- [ ] 보안 테스트 (Suite 4) 100% 통과
- [ ] E2E 플로우 (Suite 5) 완전히 작동
- [ ] 발견된 모든 이슈 해결
- [ ] 카카오 템플릿 검수 신청 완료

---

## 📝 다음 단계

M2 테스트 완료 후:
1. ✅ M2 완료 보고서 최종 검토
2. 🔄 Git commit & push
3. 🚀 M3 (간병인 플로우) 시작

---

**작성일**: 2025-12-07  
**버전**: 1.0  
**단계**: M2 검증

