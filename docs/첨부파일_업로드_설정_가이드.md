# ğŸ“ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì„¤ì • ê°€ì´ë“œ

## âœ… ì™„ë£Œëœ ì‘ì—…

1. âœ… ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„± (`0009_attachments_table.sql`)
2. âœ… RLS ì •ì±… ìˆ˜ì • (`0011_fix_users_rls_recursion.sql`)
3. âœ… ì½”ë“œ ê°œì„  (ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ì²´í™”)

---

## ğŸ”§ Supabase ì„¤ì • (í•„ìˆ˜!)

### 1ï¸âƒ£ Storage Bucket ìƒì„±

```
1. Supabase Dashboard ì ‘ì†
2. ì™¼ìª½ ë©”ë‰´ â†’ Storage í´ë¦­
3. [New bucket] ë²„íŠ¼ í´ë¦­
4. ì„¤ì •:
   - Name: attachments
   - Public bucket: âœ“ (ì²´í¬!)
5. [Create bucket] í´ë¦­
```

### 2ï¸âƒ£ Storage Policies ì„¤ì •

Storage PoliciesëŠ” **Supabase Dashboard**ì—ì„œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì‰½ìŠµë‹ˆë‹¤.

#### ë°©ë²• 1: Dashboardì—ì„œ ì„¤ì • (ê¶Œì¥)

```
1. Storage â†’ attachments bucket í´ë¦­
2. Policies íƒ­ í´ë¦­
3. [New Policy] ë²„íŠ¼ í´ë¦­

ì •ì±… 1: ì—…ë¡œë“œ í—ˆìš©
- Policy name: "ë³´í˜¸ìëŠ” ìì‹ ì˜ ì¼€ì´ìŠ¤ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥"
- Allowed operation: INSERT
- Policy definition:
  (bucket_id = 'attachments'::text) 
  AND (
    (storage.foldername(name))[1] IN (
      SELECT id::text FROM cases WHERE guardian_id = auth.uid()
    )
  )

ì •ì±… 2: ì¡°íšŒ í—ˆìš©
- Policy name: "ë³´í˜¸ìëŠ” ìì‹ ì˜ ì¼€ì´ìŠ¤ íŒŒì¼ ì¡°íšŒ ê°€ëŠ¥"
- Allowed operation: SELECT
- Policy definition:
  (bucket_id = 'attachments'::text) 
  AND (
    (storage.foldername(name))[1] IN (
      SELECT id::text FROM cases WHERE guardian_id = auth.uid()
    )
  )

ì •ì±… 3: ì‚­ì œ í—ˆìš©
- Policy name: "ë³´í˜¸ìëŠ” ìì‹ ì˜ ì¼€ì´ìŠ¤ íŒŒì¼ ì‚­ì œ ê°€ëŠ¥"
- Allowed operation: DELETE
- Policy definition:
  (bucket_id = 'attachments'::text) 
  AND (
    (storage.foldername(name))[1] IN (
      SELECT id::text FROM cases WHERE guardian_id = auth.uid()
    )
  )
```

#### ë°©ë²• 2: SQLë¡œ ì„¤ì • (ê³ ê¸‰)

**âš ï¸ ì¤‘ìš”**: `0012_storage_policies_fixed.sql` íŒŒì¼ì„ ì‚¬ìš©í•˜ì„¸ìš”!

```
1. Supabase Dashboard â†’ SQL Editor
2. 0012_storage_policies_fixed.sql íŒŒì¼ ë‚´ìš© ë³µì‚¬/ë¶™ì—¬ë„£ê¸°
3. Run í´ë¦­
4. ì •ì±… í™•ì¸ ì¿¼ë¦¬ ê²°ê³¼ í™•ì¸ (3ê°œ ì •ì±…ì´ ìƒì„±ë˜ì–´ì•¼ í•¨)
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸

```
1. ì¼€ì´ìŠ¤ ìƒì„¸ í˜ì´ì§€ ì ‘ì†
2. "ğŸ“ ì¶”ê°€ ì„œë¥˜ ì²¨ë¶€" ì„¹ì…˜ í™•ì¸
3. ì„œë¥˜ ì¢…ë¥˜ ì„ íƒ (ì˜ˆ: "ë³‘ì› ì˜ìˆ˜ì¦")
4. íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ì•¤ë“œë¡­
5. ì—…ë¡œë“œ ì„±ê³µ í™•ì¸
```

### 2. ì—ëŸ¬ í™•ì¸

ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ í™”ë©´ì— êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤:

- **"âš ï¸ Storage Bucketì´ ì—†ìŠµë‹ˆë‹¤"**
  â†’ Storage â†’ [New bucket] â†’ "attachments" ìƒì„±

- **"âš ï¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"**
  â†’ Storage Policies ì„¤ì • í™•ì¸

- **"ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"**
  â†’ ë‹¤ë¥¸ íŒŒì¼ëª…ìœ¼ë¡œ ì—…ë¡œë“œ

---

## ğŸ” ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: "Bucket not found" ì—ëŸ¬

**ì›ì¸**: Storage Bucketì´ ìƒì„±ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```
1. Supabase Dashboard â†’ Storage
2. [New bucket] í´ë¦­
3. Name: attachments
4. Public: âœ“
5. [Create bucket]
```

### ë¬¸ì œ 2: "new row violates row-level security" ì—ëŸ¬

**ì›ì¸**: Storage Policiesê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```
1. Storage â†’ attachments bucket â†’ Policies íƒ­
2. ìœ„ì˜ "Storage Policies ì„¤ì •" ì°¸ê³ í•˜ì—¬ ì •ì±… ìƒì„±
```

### ë¬¸ì œ 3: íŒŒì¼ ì—…ë¡œë“œëŠ” ë˜ì§€ë§Œ ëª©ë¡ì— ì•ˆ ë³´ì„

**ì›ì¸**: ë©”íƒ€ë°ì´í„° ì €ì¥ ì‹¤íŒ¨ (RLS ì •ì±… ë¬¸ì œ)

**í•´ê²°**:
```
1. SQL Editorì—ì„œ 0011_fix_users_rls_recursion.sql ì‹¤í–‰
2. ì„œë²„ ì¬ì‹œì‘
```

---

## ğŸ“ ì°¸ê³ ì‚¬í•­

- **íŒŒì¼ í¬ê¸° ì œí•œ**: 10MB
- **ì§€ì› í˜•ì‹**: PDF, JPG, PNG
- **ê°™ì€ ì¢…ë¥˜ ì—¬ëŸ¬ íŒŒì¼**: ê°€ëŠ¥ (ì˜ˆ: ë³‘ì› ì˜ìˆ˜ì¦ 3ê°œ)
- **í•œê¸€ íŒŒì¼ëª…**: ìë™ìœ¼ë¡œ ì •ë¦¬ë¨

---

## âœ… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Storage Bucket ìƒì„± (attachments)
- [ ] Storage Policies ì„¤ì • (3ê°œ)
- [ ] SQL ì‹¤í–‰ (0011_fix_users_rls_recursion.sql)
- [ ] íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
- [ ] íŒŒì¼ ì¡°íšŒ í…ŒìŠ¤íŠ¸
- [ ] íŒŒì¼ ì‚­ì œ í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì¼**: 2025-12-08  
**ìƒíƒœ**: âœ… ì„¤ì • ì™„ë£Œ ì‹œ ì •ìƒ ì‘ë™

