# ğŸš¨ ê¸´ê¸‰ ë³´ì•ˆ ìˆ˜ì • ê°€ì´ë“œ

## âš ï¸ ë°œê²¬ëœ ë¬¸ì œ

**ì‹¬ê°ë„**: ğŸ”´ CRITICAL

### ë¬¸ì œ 1: ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë°ì´í„° ë…¸ì¶œ
- **ì¦ìƒ**: ìƒˆë¡œ ê°€ì…í•œ ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ê°„ë³‘ ì¼€ì´ìŠ¤ë¥¼ ë³¼ ìˆ˜ ìˆìŒ
- **ì›ì¸**: 
  1. `getCases()` í•¨ìˆ˜ê°€ `guardian_id` í•„í„°ë§ ì—†ì´ ëª¨ë“  ì¼€ì´ìŠ¤ ì¡°íšŒ
  2. ë°ì´í„°ë² ì´ìŠ¤ì— "í…ŒìŠ¤íŠ¸ìš©_cases_ëª¨ë‘í—ˆìš©" RLS ì •ì±… í™œì„±í™”
  
### ë¬¸ì œ 2: ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ ë³´ì•ˆ ì·¨ì•½
- **ì›ì¸**: `0001_init_database.sql`ì—ì„œ í…ŒìŠ¤íŠ¸ìš© ì •ì±…ì´ í”„ë¡œë•ì…˜ì—ì„œë„ í™œì„±í™”ë¨

---

## âœ… ì ìš©ëœ ìˆ˜ì •ì‚¬í•­

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ìˆ˜ì •

#### `src/modules/case/actions.ts`
```typescript
// Before: ëª¨ë“  ì¼€ì´ìŠ¤ ì¡°íšŒ âŒ
export async function getCases() {
  const { data: cases } = await supabase
    .from("cases")
    .select("*");  // â† í•„í„°ë§ ì—†ìŒ!
  return cases;
}

// After: ë³¸ì¸ ì¼€ì´ìŠ¤ë§Œ ì¡°íšŒ âœ…
export async function getCases() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect("/login");
  
  const { data: userData } = await supabase
    .from("users")
    .select("id")
    .eq("id", user.id)
    .single();
  
  const { data: cases } = await supabase
    .from("cases")
    .select("*")
    .eq("guardian_id", userData.id); // â† ë³¸ì¸ ì¼€ì´ìŠ¤ë§Œ!
  return cases;
}
```

#### `getCase(id)` í•¨ìˆ˜ë„ ë™ì¼í•˜ê²Œ ìˆ˜ì •ë¨

### 2. ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ ìˆ˜ì •

#### ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
`supabase/migrations/0004_fix_rls_security.sql`

**ì£¼ìš” ë³€ê²½ì‚¬í•­**:
1. âŒ í…ŒìŠ¤íŠ¸ìš© ì •ì±… ì œê±°
   - `í…ŒìŠ¤íŠ¸ìš©_users_ëª¨ë‘í—ˆìš©`
   - `í…ŒìŠ¤íŠ¸ìš©_cases_ëª¨ë‘í—ˆìš©`
   - `í…ŒìŠ¤íŠ¸ìš©_case_tokens_ëª¨ë‘í—ˆìš©`
   - `í…ŒìŠ¤íŠ¸ìš©_care_logs_ëª¨ë‘í—ˆìš©`
   - `í…ŒìŠ¤íŠ¸ìš©_payments_ëª¨ë‘í—ˆìš©`

2. âœ… ë³´ì•ˆ ì •ì±… ì ìš©
   - Users: `auth.uid() = id`
   - Cases: `auth.uid() = guardian_id`
   - Case Tokens: guardian_id ì²´í¬
   - Care Logs: guardian_id ì²´í¬
   - Payments: guardian_id ì²´í¬

### 3. UI í…ìŠ¤íŠ¸ ìˆ˜ì •
- "ë‚´ ê°„ë³‘ ì¼ê°" â†’ "ë‚´ ê°„ë³‘ ì§„í–‰ì‚¬í•­"

---

## ğŸ”§ ì ìš© ë°©ë²•

### 1ë‹¨ê³„: ì½”ë“œ ìˆ˜ì • (ì™„ë£Œ âœ…)
- `src/modules/case/actions.ts` - í•„í„°ë§ ì¶”ê°€
- `src/app/cases/page.tsx` - ì œëª© ë³€ê²½

### 2ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ ì •ì±… ì ìš© (í•„ìˆ˜!)

#### Supabase Dashboardì—ì„œ ì‹¤í–‰:
1. **Supabase Dashboard** ì ‘ì†
2. **SQL Editor** ë©”ë‰´ ì„ íƒ
3. **New Query** í´ë¦­
4. `supabase/migrations/0004_fix_rls_security.sql` íŒŒì¼ ë‚´ìš© ë³µì‚¬
5. ë¶™ì—¬ë„£ê¸° í›„ **Run** í´ë¦­

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### âœ… ì •ìƒ ë™ì‘ í™•ì¸

#### ì‚¬ìš©ì A (ê¸°ì¡´ ì‚¬ìš©ì)
1. ë¡œê·¸ì¸
2. ë³¸ì¸ì´ ìƒì„±í•œ ì¼€ì´ìŠ¤ë§Œ ë³´ì„ âœ…
3. ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì¼€ì´ìŠ¤ëŠ” ë³´ì´ì§€ ì•ŠìŒ âœ…

#### ì‚¬ìš©ì B (ìƒˆ ì‚¬ìš©ì)
1. íšŒì›ê°€ì…
2. ë¡œê·¸ì¸
3. **ë¹ˆ ì¼€ì´ìŠ¤ ëª©ë¡** í‘œì‹œë¨ âœ…
4. ì‚¬ìš©ì Aì˜ ì¼€ì´ìŠ¤ê°€ ë³´ì´ì§€ ì•ŠìŒ âœ…

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ë°˜ë“œì‹œ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤**
   - ì½”ë“œë§Œ ìˆ˜ì •í•´ì„œëŠ” ë¶€ì¡±í•©ë‹ˆë‹¤
   - ë°ì´í„°ë² ì´ìŠ¤ ì •ì±…ì´ ìµœì¢… ë°©ì–´ì„ ì…ë‹ˆë‹¤

2. **ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„°ëŠ” ì˜í–¥ ì—†ìŒ**
   - ì •ì±…ë§Œ ë³€ê²½ë˜ë©°, ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤

3. **Service Role Key ì‚¬ìš© ì£¼ì˜**
   - `adminSupabase`ëŠ” RLSë¥¼ ìš°íšŒí•©ë‹ˆë‹¤
   - ê¼­ í•„ìš”í•œ ê³³(`phone_otps`, `rate_limits`)ì—ë§Œ ì‚¬ìš©

---

## ğŸ“Š ë³´ì•ˆ ê°•í™” íš¨ê³¼

| í•­ëª© | Before | After |
|------|--------|-------|
| ì¼€ì´ìŠ¤ ì¡°íšŒ | ëª¨ë“  ì¼€ì´ìŠ¤ ë…¸ì¶œ âŒ | ë³¸ì¸ ì¼€ì´ìŠ¤ë§Œ âœ… |
| RLS ì •ì±… | í…ŒìŠ¤íŠ¸ìš© (ëª¨ë‘ í—ˆìš©) âŒ | ë³´ì•ˆ ì •ì±… âœ… |
| ë°ì´í„° í•„í„°ë§ | ì—†ìŒ âŒ | guardian_id í•„í„°ë§ âœ… |
| ë‹¤ë¥¸ ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ | ê°€ëŠ¥ âŒ | ë¶ˆê°€ëŠ¥ âœ… |

---

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] 1. `getCases()` í•¨ìˆ˜ ìˆ˜ì •
- [x] 2. `getCase(id)` í•¨ìˆ˜ ìˆ˜ì •
- [x] 3. UI í…ìŠ¤íŠ¸ ë³€ê²½
- [x] 4. SQL ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
- [ ] 5. **SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (Supabase Dashboard)** â† ë°˜ë“œì‹œ ì‹¤í–‰!
- [ ] 6. í…ŒìŠ¤íŠ¸: ì‚¬ìš©ì A ë¡œê·¸ì¸ â†’ ë³¸ì¸ ì¼€ì´ìŠ¤ë§Œ ë³´ì„
- [ ] 7. í…ŒìŠ¤íŠ¸: ì‚¬ìš©ì B íšŒì›ê°€ì… â†’ ë¹ˆ ëª©ë¡ í‘œì‹œ

---

## ğŸ” ì¶”ê°€ ê¶Œì¥ì‚¬í•­

### 1. ì •ê¸° ë³´ì•ˆ ì ê²€
- ëª¨ë“  Server Actionsì—ì„œ ì‚¬ìš©ì ì¸ì¦ í™•ì¸
- RLS ì •ì±… ì •ê¸° ë¦¬ë·°

### 2. ë¡œê¹… ì¶”ê°€
```typescript
// ì¤‘ìš” ì‘ì—… ì‹œ ë¡œê·¸ ë‚¨ê¸°ê¸°
console.log(`[Security] User ${user.id} accessed cases`);
```

### 3. ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
```typescript
if (!user) {
  console.error('[Security] Unauthorized access attempt');
  redirect("/login");
}
```

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-12-07
**ì‘ì„±ì**: AI Assistant
**ê²€í†  í•„ìš”**: SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í›„ í…ŒìŠ¤íŠ¸ í•„ìˆ˜!

