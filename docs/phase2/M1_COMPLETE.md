# âœ… M1 2ì°¨ - ê³„ì •/ì¸ì¦/ìœ ì € ê¸°ë³¸ ë ˆì´ì–´ ì™„ë£Œ

## ðŸŽ¯ ëª©í‘œ ë‹¬ì„± í˜„í™©

### âœ… ì™„ë£Œëœ ìž‘ì—…

1. **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ**
   - [x] `users` í…Œì´ë¸” (íœ´ëŒ€í° ì¸ì¦ ê¸°ë°˜, role êµ¬ì¡°)
   - [x] `phone_otps` í…Œì´ë¸” (ì¸ì¦ë²ˆí˜¸ ê´€ë¦¬)
   - [x] `rate_limits` í…Œì´ë¸” (ë¬¸ìž ë°œì†¡ ì œí•œ)
   - [x] RLS ì •ì±… ì ìš© (ë³´ì•ˆ ê°•í™”)
   - [x] í—¬í¼ í•¨ìˆ˜ 4ê°œ ìƒì„±

2. **íœ´ëŒ€í° ë¬¸ìž ì¸ì¦ ì‹œìŠ¤í…œ**
   - [x] Solapi ì—°ë™ (ê°œë°œ/ìš´ì˜ ëª¨ë“œ ë¶„ë¦¬)
   - [x] 6ìžë¦¬ ì½”ë“œ ìƒì„± ë° í•´ì‹œ ì €ìž¥
   - [x] RateLimit ì ìš© (1ë¶„ 1íšŒ, í•˜ë£¨ 10íšŒ)
   - [x] OTP ë§Œë£Œ ì²˜ë¦¬ (5ë¶„)
   - [x] ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì œí•œ (5íšŒ)

3. **ì¸ì¦ íŽ˜ì´ì§€ (/auth/phone)**
   - [x] 3ë‹¨ê³„ ì¸ì¦ í”„ë¡œì„¸ìŠ¤
   - [x] ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
   - [x] íƒ€ì´ë¨¸ í‘œì‹œ
   - [x] ì‹ ê·œ ê°€ìž… / ìž¬ë¡œê·¸ì¸ êµ¬ë¶„
   - [x] ì—ëŸ¬ ì²˜ë¦¬ ë° ì‚¬ìš©ìž í”¼ë“œë°±

4. **í”„ë¡œí•„ ê´€ë¦¬ (/profile)**
   - [x] ì‚¬ìš©ìž ì •ë³´ ì¡°íšŒ
   - [x] ì´ë¦„, ìƒë…„ì›”ì¼, ì´ë©”ì¼ ìˆ˜ì •
   - [x] ì „í™”ë²ˆí˜¸ ì½ê¸° ì „ìš©
   - [x] ì—­í•  í‘œì‹œ

5. **ê´€ë¦¬ìž ëŒ€ì‹œë³´ë“œ (/admin)**
   - [x] ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´
   - [x] í†µê³„ ëŒ€ì‹œë³´ë“œ
   - [x] ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ë©”ë‰´
   - [x] ê¶Œí•œ ì—†ìŒ íŽ˜ì´ì§€

6. **ë¯¸ë“¤ì›¨ì–´ ì—…ë°ì´íŠ¸**
   - [x] ë³´í˜¸ëœ ê²½ë¡œ ê´€ë¦¬
   - [x] admin ê¶Œí•œ ì²´í¬
   - [x] ìžë™ ë¦¬ë‹¤ì´ë ‰íŠ¸

---

## ðŸ“‚ ìƒì„±ëœ íŒŒì¼ ëª©ë¡

```
í”„ë¡œì íŠ¸ ë£¨íŠ¸/
â”œâ”€â”€ supabase/migrations/
â”‚   â””â”€â”€ 0003_phase2_m1_auth.sql               # ì‹ ê·œ ìƒì„±
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â””â”€â”€ actions.ts                     # ì‹ ê·œ ìƒì„± (500+ ë¼ì¸)
â”‚   â”‚   â””â”€â”€ shared/
â”‚   â”‚       â”œâ”€â”€ lib/
â”‚   â”‚       â”‚   â””â”€â”€ solapi.ts                  # ì‹ ê·œ ìƒì„±
â”‚   â”‚       â””â”€â”€ types/
â”‚   â”‚           â””â”€â”€ auth.ts                    # ì‹ ê·œ ìƒì„±
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ auth/phone/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                       # ì‹ ê·œ ìƒì„±
â”‚   â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx                       # ì‹ ê·œ ìƒì„±
â”‚   â”‚   â”‚   â””â”€â”€ profile-form.tsx               # ì‹ ê·œ ìƒì„±
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â””â”€â”€ page.tsx                       # ì‹ ê·œ ìƒì„±
â”‚   â””â”€â”€ middleware.ts                          # ì—…ë°ì´íŠ¸
â””â”€â”€ docs/phase2/
    â””â”€â”€ M1_COMPLETE.md                         # ì´ íŒŒì¼
```

**ì´ íŒŒì¼**: ì‹ ê·œ 10ê°œ, ì—…ë°ì´íŠ¸ 1ê°œ

---

## ðŸš€ ë‹¤ìŒ ë‹¨ê³„ (ì‚¬ìš©ìžê°€ ìˆ˜í–‰í•´ì•¼ í•  ìž‘ì—…)

### Step 1: Supabase SQL ì‹¤í–‰ âš ï¸ **í•„ìˆ˜**

1. Supabase Dashboard â†’ SQL Editor
2. `supabase/migrations/0003_phase2_m1_auth.sql` íŒŒì¼ ë‚´ìš© ë³µì‚¬
3. ë¶™ì—¬ë„£ê³  `Run` í´ë¦­
4. ì„±ê³µ ë©”ì‹œì§€ í™•ì¸

**ìƒì„±ë˜ëŠ” í•­ëª©**:
- í…Œì´ë¸”: users, phone_otps, rate_limits
- í•¨ìˆ˜: get_current_user_role, is_admin, cleanup_expired_otps, cleanup_old_rate_limits
- RLS ì •ì±…: ê° í…Œì´ë¸”ë³„ ì ‘ê·¼ ì œì–´

---

### Step 2: Solapi ê³„ì • ì„¤ì • (ê°œë°œ ëª¨ë“œëŠ” ìƒëžµ ê°€ëŠ¥)

**ê°œë°œ ëª¨ë“œ (í˜„ìž¬ ìƒíƒœ)**:
- SMSëŠ” ì½˜ì†”ì—ë§Œ ì¶œë ¥ë¨
- ì‹¤ì œ ë°œì†¡ ì—†ìŒ
- í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

**ìš´ì˜ ëª¨ë“œ (ë‚˜ì¤‘ì— ì„¤ì •)**:
1. Solapi íšŒì›ê°€ìž…: https://solapi.com
2. ë°œì‹ ë²ˆí˜¸ ë“±ë¡ (ë³¸ì¸ íœ´ëŒ€í°)
3. API Key ë°œê¸‰
4. `.env.local`ì— ì¶”ê°€:
   ```bash
   SOLAPI_API_KEY=your-api-key
   SOLAPI_API_SECRET=your-api-secret
   SOLAPI_SENDER_PHONE=01012345678
   ```

---

### Step 3: ë¡œì»¬ ì„œë²„ ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸

```bash
# ì„œë²„ ì‹¤í–‰
cmd /c "npm run dev"

# ë¸Œë¼ìš°ì € ì ‘ì†
http://localhost:3000/auth/phone
```

**í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**:
1. âœ… ì „í™”ë²ˆí˜¸ ìž…ë ¥ â†’ ì¸ì¦ë²ˆí˜¸ ë°›ê¸°
2. âœ… ì½˜ì†”ì—ì„œ 6ìžë¦¬ ì½”ë“œ í™•ì¸
3. âœ… ì½”ë“œ ìž…ë ¥ â†’ ì´ë¦„ ìž…ë ¥ â†’ ê°€ìž… ì™„ë£Œ
4. âœ… `/cases` íŽ˜ì´ì§€ë¡œ ìžë™ ì´ë™
5. âœ… `/profile`ì—ì„œ ì •ë³´ ìˆ˜ì •
6. âœ… ë¡œê·¸ì•„ì›ƒ í›„ ìž¬ë¡œê·¸ì¸

---

## ðŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### WP1.1: íœ´ëŒ€í° ë¬¸ìž ì¸ì¦ (+ RateLimit)

- [ ] **Scenario WP1.1-1: ìµœì´ˆ íšŒì›ê°€ìž… ì„±ê³µ**
  - ì „í™”ë²ˆí˜¸ ìž…ë ¥ â†’ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
  - ì½˜ì†”ì—ì„œ ì½”ë“œ í™•ì¸ (ê°œë°œ ëª¨ë“œ)
  - ì½”ë“œ ìž…ë ¥ â†’ ì´ë¦„ ë“± ì •ë³´ ìž…ë ¥
  - `/cases`ë¡œ ìžë™ ì´ë™
  - `users` í…Œì´ë¸”ì— ì‹ ê·œ row ìƒì„± í™•ì¸

- [ ] **Scenario WP1.1-2: ê¸°ì¡´ íšŒì› ìž¬ë¡œê·¸ì¸**
  - ë™ì¼ ì „í™”ë²ˆí˜¸ë¡œ ì¸ì¦
  - ì¶”ê°€ ì •ë³´ ìž…ë ¥ ì—†ì´ ë°”ë¡œ ë¡œê·¸ì¸
  - `users` row ê°œìˆ˜ ì¦ê°€í•˜ì§€ ì•ŠìŒ

- [ ] **Scenario WP1.1-3: ìž˜ëª»ëœ ì¸ì¦ë²ˆí˜¸ ìž…ë ¥**
  - í‹€ë¦° ì½”ë“œ ìž…ë ¥
  - "ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ
  - ë¡œê·¸ì¸ ì‹¤íŒ¨

- [ ] **Scenario WP1.1-4: ë§Œë£Œëœ ì¸ì¦ë²ˆí˜¸**
  - 5ë¶„ ì´ìƒ ê²½ê³¼ í›„ ì½”ë“œ ìž…ë ¥
  - "ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€
  - ìƒˆë¡œìš´ ì¸ì¦ë²ˆí˜¸ ìš”ì²­ í•„ìš”

- [ ] **Scenario WP1.1-5: RateLimit ì´ˆê³¼**
  - 1ë¶„ ë‚´ 2íšŒ ì´ìƒ ìš”ì²­
  - "ìš”ì²­ì´ ë„ˆë¬´ ìž¦ìŠµë‹ˆë‹¤" ë©”ì‹œì§€
  - SMS ë°œì†¡ ì°¨ë‹¨

### WP1.2: í”„ë¡œí•„ ì¡°íšŒ/ìˆ˜ì •

- [ ] **Scenario WP1.2-1: ë‚´ í”„ë¡œí•„ ì¡°íšŒ**
  - `/profile` ì ‘ì†
  - ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ë“± í‘œì‹œ í™•ì¸
  - ì—­í•  badge í‘œì‹œ í™•ì¸

- [ ] **Scenario WP1.2-2: í”„ë¡œí•„ ìˆ˜ì •**
  - ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ë³€ê²½
  - ì €ìž¥ ë²„íŠ¼ í´ë¦­
  - ìƒˆë¡œê³ ì¹¨ í›„ ë³€ê²½ ì‚¬í•­ ìœ ì§€ í™•ì¸

- [ ] **Scenario WP1.2-3: ì „í™”ë²ˆí˜¸ ìˆ˜ì • ë¶ˆê°€**
  - ì „í™”ë²ˆí˜¸ í•„ë“œ í´ë¦­ ì‹œë„
  - ì½ê¸° ì „ìš©ìœ¼ë¡œ ìˆ˜ì • ë¶ˆê°€
  - ì•ˆë‚´ ë¬¸êµ¬ í™•ì¸

### WP1.3: role êµ¬ì¡° & /admin ì ‘ê·¼ ì œí•œ

- [ ] **Scenario WP1.3-1: ì¼ë°˜ ë³´í˜¸ìžì˜ /admin ì°¨ë‹¨**
  - guardian ì—­í•  ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
  - `/admin` ì ‘ì† ì‹œë„
  - `/cases`ë¡œ ìžë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë˜ëŠ” ê¶Œí•œ ì—†ìŒ íŽ˜ì´ì§€

- [ ] **Scenario WP1.3-2: Admin ê³„ì •ì˜ /admin ì ‘ê·¼**
  - Supabaseì—ì„œ `role='admin'` ì„¤ì •
  - `/admin` ì ‘ì†
  - ìš´ì˜ìž ëŒ€ì‹œë³´ë“œ í‘œì‹œ
  - í†µê³„ ë° ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ ë©”ë‰´ í™•ì¸

---

## ðŸ”§ ì£¼ìš” ê¸°ìˆ  êµ¬í˜„ ìƒì„¸

### 1. íœ´ëŒ€í° ì¸ì¦ í”Œë¡œìš°

```
ì‚¬ìš©ìž ìž…ë ¥
    â†“
ì „í™”ë²ˆí˜¸ ê²€ì¦ (ì •ê·œì‹)
    â†“
RateLimit ì²´í¬
    â†“
6ìžë¦¬ ì½”ë“œ ìƒì„±
    â†“
SHA-256 í•´ì‹œ ì €ìž¥ (phone_otps)
    â†“
SMS ë°œì†¡ (Solapi)
    â†“
RateLimit ì—…ë°ì´íŠ¸
    â†“
ì‚¬ìš©ìžê°€ ì½”ë“œ ìž…ë ¥
    â†“
í•´ì‹œ ë¹„êµ ê²€ì¦
    â†“
ì„±ê³µ ì‹œ:
  - ê¸°ì¡´ ìœ ì €: ë¡œê·¸ì¸
  - ì‹ ê·œ ìœ ì €: ì¶”ê°€ ì •ë³´ ìž…ë ¥ â†’ íšŒì›ê°€ìž…
    â†“
Supabase Auth ì„¸ì…˜ ìƒì„±
    â†“
/casesë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```

### 2. RateLimit ë¡œì§

```typescript
// ì²´í¬ ì¡°ê±´
1. 1ë¶„ ë‚´ ìž¬ìš”ì²­: ì°¨ë‹¨
2. 24ì‹œê°„ ë‚´ 10íšŒ ì´ˆê³¼: ì°¨ë‹¨
3. 24ì‹œê°„ ê²½ê³¼: ì¹´ìš´í„° ë¦¬ì…‹

// êµ¬í˜„ ë°©ì‹
rate_limits í…Œì´ë¸”:
- identifier: ì „í™”ë²ˆí˜¸
- attempt_count: ì‹œë„ íšŸìˆ˜
- last_attempt_at: ë§ˆì§€ë§‰ ì‹œë„ ì‹œê°„
- first_attempt_at: ì²« ì‹œë„ ì‹œê°„ (24ì‹œê°„ ê³„ì‚°ìš©)
```

### 3. RLS ì •ì±…

```sql
-- users í…Œì´ë¸”
1. ë³¸ì¸ ì •ë³´ë§Œ ì¡°íšŒ ê°€ëŠ¥
2. ë³¸ì¸ ì •ë³´ë§Œ ìˆ˜ì • ê°€ëŠ¥
3. adminì€ ëª¨ë“  users ì¡°íšŒ ê°€ëŠ¥

-- phone_otps, rate_limits
1. Service Role Keyë§Œ ì ‘ê·¼ ê°€ëŠ¥
2. ì¼ë°˜ ì‚¬ìš©ìžëŠ” ì ‘ê·¼ ë¶ˆê°€ (ë³´ì•ˆ)
```

### 4. ë¯¸ë“¤ì›¨ì–´ ê²½ë¡œ ë³´í˜¸

```typescript
Public (ì¸ì¦ ë¶ˆí•„ìš”):
- /auth/*
- /debug/*
- /caregiver/*
- /privacy
- /

Protected (ì¸ì¦ í•„ìš”):
- /cases/*
- /profile
- /admin/*

Admin Only:
- /admin/*
  â†’ guardian ì—­í• ì€ /casesë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```

---

## ðŸ’¡ í•µì‹¬ ê¸°ëŠ¥ í•˜ì´ë¼ì´íŠ¸

### 1. ê°œë°œ ëª¨ë“œ ì§€ì›

```typescript
// solapi.ts
if (isDevelopment || !apiKey) {
  console.log('[ê°œë°œ ëª¨ë“œ] SMS ë°œì†¡ ì‹œë®¬ë ˆì´ì…˜');
  console.log(`ìˆ˜ì‹ ìž: ${to}`);
  console.log(`ë‚´ìš©: ${message}`);
  return { success: true };
}
```

**ìž¥ì **:
- ì‹¤ì œ SMS í¬ë ˆë”§ ì†Œëª¨ ì—†ìŒ
- í…ŒìŠ¤íŠ¸ íŽ¸ì˜ì„± í–¥ìƒ
- ìš´ì˜ ëª¨ë“œë¡œ ì‰½ê²Œ ì „í™˜ ê°€ëŠ¥

### 2. ì•ˆì „í•œ ì½”ë“œ ì €ìž¥

```typescript
// í•´ì‹œ ì €ìž¥
const codeHash = await hashCode(code); // SHA-256
await supabase.from('phone_otps').insert({
  code_hash: codeHash, // í‰ë¬¸ ì €ìž¥ âŒ, í•´ì‹œ ì €ìž¥ âœ…
  expires_at: expiresAt,
});
```

### 3. íƒ€ì´ë¨¸ UX

```typescript
// ì¸ì¦ë²ˆí˜¸ ë§Œë£Œ ì‹œê°„ í‘œì‹œ
const formatTime = (seconds) => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
};

// 3:45, 0:30 ë“±ìœ¼ë¡œ í‘œì‹œ
```

### 4. ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…

```typescript
// 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ìžë™ ë³€í™˜
const formatPhone = (value) => {
  const numbers = value.replace(/[^0-9]/g, '');
  if (numbers.length <= 3) return numbers;
  if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
  return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
};
```

---

## ðŸŽ“ M1ì—ì„œ ë°°ìš´ í•µì‹¬ ê°œë…

### 1. íœ´ëŒ€í° ì¸ì¦ì˜ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

**ì¤‘ìš”**:
- âœ… í‰ë¬¸ ì €ìž¥ ê¸ˆì§€ â†’ í•´ì‹œ ì‚¬ìš©
- âœ… RateLimit í•„ìˆ˜ â†’ ë¬´ì°¨ë³„ ëŒ€ìž… ë°©ì§€
- âœ… ë§Œë£Œ ì‹œê°„ ì„¤ì • â†’ 5ë¶„
- âœ… ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì œí•œ â†’ 5íšŒ

### 2. Service Role Key vs Anon Key

**Anon Key** (NEXT_PUBLIC_):
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©
- RLS ì •ì±… ì ìš©ë¨
- ì œí•œëœ ê¶Œí•œ

**Service Role Key** (ì„œë²„ ì „ìš©):
- ë°±ì—”ë“œ/Server Actionsì—ì„œë§Œ ì‚¬ìš©
- RLS ìš°íšŒ ê°€ëŠ¥
- phone_otps, rate_limits ì ‘ê·¼ìš©

### 3. Supabase Auth í†µí•©

```typescript
// users í…Œì´ë¸” + Supabase Auth ì—°ë™
auth_email: `${phone}@care.local`

// ìž¥ì :
- ê¸°ì¡´ Supabase Auth ê¸°ëŠ¥ í™œìš©
- ì„¸ì…˜ ê´€ë¦¬ ìžë™í™”
- RLSì—ì„œ auth.uid() ì‚¬ìš© ê°€ëŠ¥
```

### 4. 3ì°¨ í™•ìž¥ ì¤€ë¹„

**ë°ì´í„° ë³´ê´€/ìµëª…í™”**:
- users í…Œì´ë¸” ì„¤ê³„ ì‹œ ê³ ë ¤
- created_at, updated_at í¬í•¨
- ë‚˜ì¤‘ì— retention ì •ì±… ì¶”ê°€ ê°€ëŠ¥

**ì¶”ê°€ ì¸ì¦ ë°©ì‹**:
- Solapi ìœ í‹¸ë¦¬í‹° êµ¬ì¡°í™”
- ë‹¤ë¥¸ SMS ì œê³µìžë¡œ ì‰½ê²Œ êµì²´ ê°€ëŠ¥

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œí•œì‚¬í•­

### 1. í˜„ìž¬ ì œí•œì‚¬í•­

**ì¸ì¦ ë°©ì‹**:
- íœ´ëŒ€í° ë²ˆí˜¸ë§Œ ì§€ì›
- ì´ë©”ì¼ ì¸ì¦ì€ ë¯¸ì§€ì› (3ì°¨ì—ì„œ ê³ ë ¤)

**RateLimit**:
- í•˜ë“œì½”ë”©ëœ ê°’ (1ë¶„ 1íšŒ, í•˜ë£¨ 10íšŒ)
- ë‚˜ì¤‘ì— í™˜ê²½ ë³€ìˆ˜í™” ê°€ëŠ¥

**Admin ê³„ì • ìƒì„±**:
- ìˆ˜ë™ìœ¼ë¡œ Supabaseì—ì„œ ì„¤ì • í•„ìš”
- ìžë™í™”ëœ admin ì´ˆëŒ€ ê¸°ëŠ¥ ì—†ìŒ (M4ì—ì„œ ì¶”ê°€)

### 2. ì•Œë ¤ì§„ ì´ìŠˆ

**Supabase Auth ë¡œê·¸ì¸**:
- í˜„ìž¬ëŠ” dummy password ì‚¬ìš©
- 3ì°¨ì—ì„œ Supabase passwordless ë°©ì‹ìœ¼ë¡œ ì „í™˜ ê³ ë ¤

**OTP ì •ë¦¬**:
- ë§Œë£Œëœ OTP ìžë™ ì‚­ì œëŠ” M5ì—ì„œ pg_cronìœ¼ë¡œ êµ¬í˜„
- í˜„ìž¬ëŠ” ìˆ˜ë™ìœ¼ë¡œ `cleanup_expired_otps()` í˜¸ì¶œ í•„ìš”

---

## ðŸ“Š M1 ì™„ë£Œ ì§€í‘œ

| í•­ëª© | ëª©í‘œ | í˜„ìž¬ ìƒíƒœ | ë¹„ê³  |
|------|------|-----------|------|
| DB ìŠ¤í‚¤ë§ˆ | âœ… | âœ… ì™„ë£Œ | 3ê°œ í…Œì´ë¸”, 4ê°œ í•¨ìˆ˜ |
| íœ´ëŒ€í° ì¸ì¦ | âœ… | âœ… ì™„ë£Œ | RateLimit í¬í•¨ |
| í”„ë¡œí•„ ê´€ë¦¬ | âœ… | âœ… ì™„ë£Œ | ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥ |
| Admin ëŒ€ì‹œë³´ë“œ | âœ… | âœ… ì™„ë£Œ | í†µê³„ ë° ë©”ë‰´ |
| ë¯¸ë“¤ì›¨ì–´ | âœ… | âœ… ì™„ë£Œ | ê²½ë¡œ ë³´í˜¸ |
| Lint ì—ëŸ¬ | 0ê°œ | âœ… 0ê°œ | ëª¨ë“  íŒŒì¼ ê²€ì¦ |
| SQL ì‹¤í–‰ | âœ… | â³ ì‚¬ìš©ìž ìž‘ì—… ëŒ€ê¸° | í•„ìˆ˜ |
| Solapi ì„¤ì • | ðŸ“¦ ì„ íƒ | â¹ï¸ ê°œë°œ ëª¨ë“œ | ìš´ì˜ ì‹œ ì„¤ì • |
| í…ŒìŠ¤íŠ¸ | âœ… | â³ ì‚¬ìš©ìž ìž‘ì—… ëŒ€ê¸° | í•„ìˆ˜ |

---

## ðŸ”— ë‹¤ìŒ ë‹¨ê³„: M2 ì¤€ë¹„

M1 ì™„ë£Œ í›„ ë°”ë¡œ ì§„í–‰ ê°€ëŠ¥:

**M2 - ë³´í˜¸ìž í”Œë¡œìš° MVP (+ ì¹´ì¹´ì˜¤ í…œí”Œë¦¿ ì‹ ì²­)**
- ê¸°ì¡´ `/cases` ê¸°ëŠ¥ ìœ ì§€
- ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ í…œí”Œë¦¿ ì‹ ì²­ (ìŠ¹ì¸ ëŒ€ê¸° ì‹œê°„ ê³ ë ¤)
- ì¼€ì´ìŠ¤ ìƒì„±/ì¡°íšŒ ê¸°ëŠ¥ ê°•í™”

**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 
- ì½”ë“œ ìž‘ì—…: 3-4ì‹œê°„
- ì¹´ì¹´ì˜¤ í…œí”Œë¦¿ ìŠ¹ì¸: 1-3ì¼

---

## ðŸ› ë¬¸ì œ í•´ê²° (Troubleshooting)

### ë¬¸ì œ 1: "ì „í™”ë²ˆí˜¸ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ìž…ë‹ˆë‹¤"

**ì›ì¸**: users í…Œì´ë¸”ì— ë™ì¼ phone ì¡´ìž¬

**í•´ê²°**:
```sql
-- Supabase SQL Editorì—ì„œ í™•ì¸
SELECT * FROM users WHERE phone = '01012345678';

-- í…ŒìŠ¤íŠ¸ ê³„ì • ì‚­ì œ (í•„ìš” ì‹œ)
DELETE FROM users WHERE phone = '01012345678';
```

### ë¬¸ì œ 2: RateLimitì´ í’€ë¦¬ì§€ ì•ŠìŒ

**ì›ì¸**: rate_limits í…Œì´ë¸”ì˜ ê¸°ë¡ì´ ë‚¨ì•„ìžˆìŒ

**í•´ê²°**:
```sql
-- íŠ¹ì • ë²ˆí˜¸ì˜ RateLimit ì´ˆê¸°í™”
DELETE FROM rate_limits WHERE identifier = '01012345678';

-- ë˜ëŠ” í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ
SELECT cleanup_old_rate_limits();
```

### ë¬¸ì œ 3: Admin íŽ˜ì´ì§€ ì ‘ê·¼ ë¶ˆê°€

**ì›ì¸**: roleì´ 'guardian'ìœ¼ë¡œ ì„¤ì •ë¨

**í•´ê²°**:
```sql
-- ë³¸ì¸ ê³„ì •ì„ adminìœ¼ë¡œ ë³€ê²½
UPDATE users
SET role = 'admin'
WHERE phone = '01012345678';
```

### ë¬¸ì œ 4: Solapi ë°œì†¡ ì‹¤íŒ¨ (ìš´ì˜ ëª¨ë“œ)

**ì›ì¸**: API í‚¤ ì˜¤ë¥˜ ë˜ëŠ” í¬ë ˆë”§ ë¶€ì¡±

**í•´ê²°**:
1. `.env.local` íŒŒì¼ì˜ Solapi í‚¤ í™•ì¸
2. Solapi ëŒ€ì‹œë³´ë“œì—ì„œ í¬ë ˆë”§ í™•ì¸
3. ë°œì‹ ë²ˆí˜¸ ìŠ¹ì¸ ìƒíƒœ í™•ì¸
4. ì„œë²„ ìž¬ì‹œìž‘

---

## ðŸ“š ê´€ë ¨ ë¬¸ì„œ

- [M0 ì™„ë£Œ ë³´ê³ ì„œ](./M0_COMPLETE.md)
- [M2 ë¡œë“œë§µ](../../roadmap/Mileston 2/Mileston M2 2ì°¨.md)
- [M2 ì‹œë‚˜ë¦¬ì˜¤](../../roadmap/Mileston 2/Mileston scenario m2 2ì°¨.md)
- [2ì°¨ PRD](../core/note2/PRD 2ì°¨.md)

---

**ìž‘ì„±ì¼**: 2024-12-06  
**ìž‘ì„±ìž**: AI Agent  
**ìƒíƒœ**: âœ… ì½”ë“œ ìž‘ì—… ì™„ë£Œ / â³ ì‚¬ìš©ìž SQL ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸ ëŒ€ê¸°

---

## ðŸŽ‰ ì¶•í•˜í•©ë‹ˆë‹¤!

M1 2ì°¨ì˜ ëª¨ë“  ì½”ë“œ ìž‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

ì´ì œ:
1. Supabaseì—ì„œ SQL ì‹¤í–‰
2. ë¡œì»¬ ì„œë²„ì—ì„œ íœ´ëŒ€í° ì¸ì¦ í…ŒìŠ¤íŠ¸
3. í”„ë¡œí•„ ìˆ˜ì • ë° Admin íŽ˜ì´ì§€ í™•ì¸

ìœ„ 3ë‹¨ê³„ë¥¼ ì™„ë£Œí•˜ë©´ M2ë¡œ ì§„í–‰í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤! ðŸš€

