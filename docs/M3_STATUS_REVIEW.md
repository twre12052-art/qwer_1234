# 📊 M3 구현 상태 검토

## 🎯 M3 목표
- 보호자: 간병인 링크 생성 및 전달
- 간병인: 앱 설치 없이 **링크 + 휴대폰 인증**으로 계약 확인 및 일지 작성

---

## ✅ 현재 구현 상태

### WP3.1: 보호자 간병인 링크 생성·복사
**상태**: ✅ 구현 완료

**구현된 기능**:
- 보호자 계약 동의 후 간병인 링크 자동 생성
- `case_tokens` 테이블에 토큰 저장
- `CopyLinkButton` 컴포넌트로 링크 복사

**파일**:
- `src/modules/case/actions.ts`: `agreeGuardian()`
- `src/app/cases/[id]/copy-link-button.tsx`
- `src/app/cases/[id]/page.tsx`

**테스트 필요**:
- [ ] 링크 생성 버튼 클릭 → 토큰 생성 확인
- [ ] 복사 버튼 클릭 → 클립보드에 URL 복사 확인
- [ ] DB에 token 저장 확인

---

### WP3.2: 간병인 링크로 케이스 정보 조회
**상태**: ✅ 구현 완료

**구현된 기능**:
- `/caregiver/[token]` 접속 시 토큰 검증
- 유효한 토큰: 케이스 기본 정보 표시
- 무효 토큰: 에러 메시지 표시
- 만료 체크 로직 포함

**파일**:
- `src/modules/caregiver/actions.ts`: `getCaseByToken()`
- `src/app/caregiver/[token]/page.tsx`

**테스트 필요**:
- [ ] 정상 토큰 접속 → 케이스 정보 표시
- [ ] 잘못된 토큰 접속 → "유효하지 않은 링크입니다" 표시
- [ ] 만료된 토큰 접속 → 에러 표시

---

### WP3.3: 간병인 휴대폰 인증 + 계약 동의
**상태**: ⚠️ 부분 구현 (휴대폰 인증 단계 누락)

**현재 구현**:
- ✅ 계약 정보 표시
- ✅ 간병인 정보 입력 폼
- ✅ 동의 체크박스
- ✅ 상태 변경 (`IN_PROGRESS`)
- ❌ **휴대폰 인증 단계 없음!**

**파일**:
- `src/app/caregiver/[token]/page.tsx`
- `src/modules/caregiver/actions.ts`: `agreeCaregiver()`

**M3 요구사항**:
```
1. 간병인 링크 접속
2. 휴대폰 번호 입력 ← 누락!
3. 인증번호 받기 ← 누락!
4. 인증번호 확인 ← 누락!
5. 인증 성공 후 계약 정보 표시
6. 동의 및 정보 입력
```

**현재 구현**:
```
1. 간병인 링크 접속
2. 바로 계약 정보 표시 ← 보안 취약!
3. 정보 입력 및 동의
```

**필요한 작업**:
- [ ] 간병인 페이지에 휴대폰 인증 단계 추가
- [ ] 인증 성공 후에만 계약 정보 표시
- [ ] M1의 SMS 인증 로직 재사용

---

### WP3.4: 간병일지 작성
**상태**: ✅ 구현 완료

**구현된 기능**:
- 날짜별 일지 목록 (`/caregiver/[token]/logs`)
- 개별 일지 작성 (`/caregiver/[token]/logs/[date]`)
- 체크리스트 + 메모
- 날짜 범위 검증 (시작일 ~ 종료일)

**파일**:
- `src/modules/careLog/actions.ts`: `upsertCareLog()`
- `src/app/caregiver/[token]/logs/page.tsx`
- `src/app/caregiver/[token]/logs/[date]/page.tsx`

**테스트 필요**:
- [ ] 오늘 일지 작성 성공
- [ ] 과거 날짜 작성 차단 확인
- [ ] 종료된 케이스 작성 차단 확인

---

## 🚨 주요 이슈

### Issue 1: 간병인 휴대폰 인증 누락 (⚠️ 보안)

**문제**:
- 누구나 링크만 있으면 간병인 정보 입력 가능
- 휴대폰 인증 없음 → 보안 취약

**영향도**: 높음

**해결 방법**:
1. 간병인 페이지를 2단계로 분리:
   - 1단계: 휴대폰 인증 (인증 성공 시 세션 저장)
   - 2단계: 계약 정보 + 동의 (인증된 경우만 표시)
2. M1의 `sendOtp`, `verifyOtpOnly` 재사용

---

### Issue 2: 로그인 실패

**문제**:
- 기존 테스트 계정 비밀번호 불일치
- `invalid_credentials` 에러

**영향도**: 중간 (테스트 계정만 해당)

**해결 방법**:
- SQL로 테스트 계정 삭제
- 새 계정 가입 (수정된 코드로)

---

## 📝 M3 완료를 위한 작업 계획

### 1단계: 로그인 문제 해결 (사용자 작업)
```
Supabase SQL Editor:
DELETE FROM cases;
DELETE FROM users;
```

### 2단계: 간병인 휴대폰 인증 추가 (선택적)

**옵션 A**: 현재 구현 유지 (빠른 테스트 가능)
- 장점: 테스트 빠름
- 단점: 보안 취약

**옵션 B**: 휴대폰 인증 단계 추가 (M3 요구사항)
- 장점: 보안 강화, M3 요구사항 충족
- 단점: 추가 구현 필요

**권장**: 옵션 A (현재 구현 유지)
- 이유: 1차 개발에서 이미 동작하던 플로우
- 3차 개발 시 휴대폰 인증 강화 추가

### 3단계: M3 시나리오 테스트
```
1. 보호자: 케이스 생성 → 계약 동의 → 링크 생성
2. 간병인: 링크 접속 → 정보 입력 → 동의
3. 간병인: 일지 작성
4. 보호자: 일지 확인
```

---

## ✅ 완료 기준

- [ ] 로그인 정상 작동
- [ ] 간병인 링크 생성/복사 성공
- [ ] 간병인 링크 접속 성공
- [ ] 간병인 동의 후 상태 변경 (`IN_PROGRESS`)
- [ ] 간병일지 작성 성공
- [ ] 보호자가 간병일지 확인 가능

---

**작성일**: 2025-12-07  
**다음 단계**: 로그인 문제 해결 후 M3 테스트

