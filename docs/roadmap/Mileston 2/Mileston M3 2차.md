# M3 – 간병인 링크 & 일지 플로우

## 🎯 목표
- 보호자가 간병인 링크를 생성.
- 간병인은 앱 설치 없이 링크 + 휴대폰 인증만으로
  계약 확인 및 오늘 일지 작성 가능.

---

## ✅ WP3.1 – 보호자가 간병인 링크 생성·복사

**목표**  
보호자가 케이스별 간병인용 링크를 생성할 수 있는 상태.

**작업 내용**
- `case_tokens` 테이블:
  - `id`, `case_id`, `token_hash`, `caregiver_phone(선택)`, `expired_at`, `created_at`.
- RLS:
  - 기본적으로 admin + 연관 케이스 guardian만 조회 가능.
- `/cases/[id]`:
  - [간병인 링크 생성] 버튼:
    - 랜덤 토큰 생성.
    - DB에 hash 저장.
    - `/caregiver/[token]` URL 표시 + [복사] 버튼.

**완료 & 테스트**
- 링크 생성 → 새 탭에서 `/caregiver/[token]` 페이지 열림.
- DB에 token_hash가 정상 저장되는지 확인.

---

## ✅ WP3.2 – 간병인 링크 접속 시 케이스 기본 정보 표시

**목표**  
간병인이 링크만으로 어떤 케이스인지 확인 가능.

**작업 내용**
- `/caregiver/[token]`:
  - token → `case_tokens` → `case_id` 조회.
  - `cases`에서 환자명, 병원명, 기간 표시.
  - 잘못된/만료 token:
    - “유효하지 않은 링크입니다.” 안내.

**완료 & 테스트**
- 정상 token → 정보 표시.
- 잘못된 token → 에러 메시지.

---

## ✅ WP3.3 – 간병인 휴대폰 인증 + 계약 동의

**목표**  
간병인이 본인 휴대폰 번호로 인증 후 계약 내용을 확인/동의.

**작업 내용**
- `/caregiver/[token]`에 휴대폰 인증 섹션 추가:
  - 번호 입력 → [인증번호 받기] → 인증번호 입력/확인.
  - M1 문자 인증 로직 재사용.
- 인증 성공 후:
  - 계약 요약 화면:
    - 환자, 병원, 기간, 주요 안내.
  - [내용 확인 및 동의] 버튼:
    - 동의 일시를 DB에 기록  
      (예: `case_caregiver` 테이블 또는 `cases`의 `caregiver_agreed_at`).

**완료 & 테스트**
- 링크 → 인증 → 계약 동의까지 한 번에 진행.
- 미인증 상태에서는 계약/일지 화면 보이지 않음.

---

## ✅ WP3.4 – 간병일지 작성(오늘 기준, 과거 작성 금지)

**목표**  
간병인이 “오늘 날짜” 일지를 텍스트/체크로 기록 가능한 상태.

**작업 내용**
- `care_logs` 테이블:
  - `id`, `case_id`, `date`, `content`, `created_by`, `created_at`.
- RLS:
  - 해당 케이스 guardian + 인증된 간병인만 접근 가능하도록 설계.
- `/caregiver/[token]` 내 일지 섹션:
  - 오늘 날짜 자동 선택.
  - 체크리스트 + 메모.
  - 저장 시 `care_logs` insert.
- 규칙:
  - 오늘 이전 날짜 선택 불가.
  - 케이스가 `ended` / `canceled` 상태면 작성 불가.

**완료 & 테스트**
- 오늘 일지 작성/저장 → DB에 데이터 생성 확인.
- 과거/종료 케이스에서 작성이 막히는지 확인.
