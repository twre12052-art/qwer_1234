# M3 – 간병인 링크 & 일지 플로우 시나리오

## WP3.1 – 보호자 간병인 링크 생성

### Scenario WP3.1-1: 간병인 링크 최초 생성 성공
- Given:  
  - 보호자 계정으로 `/cases/[id]` 상세 화면에 진입한 상태이며, 아직 링크가 생성되지 않았다.
- When:  
  - [간병인 링크 생성] 버튼을 누른다.
- Then:  
  - 랜덤 토큰이 생성되어 DB `case_tokens`에 저장되고, 화면에 `/caregiver/[token]` URL과 [복사] 버튼이 표시된다.
- 선행 Scenario: WP2.3-1  
- 테스트/검증:  
  - 버튼 클릭 후 표시된 URL 확인.  
  - `case_tokens` 테이블에서 해당 case_id row 확인.

---

### Scenario WP3.1-2: 링크 복사 버튼 동작 확인
- Given:  
  - `/cases/[id]` 화면에 간병인 링크 URL이 표시된 상태.
- When:  
  - [복사] 버튼을 클릭한다.
- Then:  
  - 시스템 클립보드에 해당 URL이 복사된다.
- 선행 Scenario: WP3.1-1  
- 테스트/검증:  
  - 새 탭 주소창에 붙여넣기 → URL 동일 여부 확인.

---

## WP3.2 – 간병인 링크로 케이스 정보 조회

### Scenario WP3.2-1: 유효한 토큰으로 케이스 정보 조회 성공
- Given:  
  - `case_tokens`에 유효한 token이 저장된 상태.
- When:  
  - 브라우저에서 `/caregiver/[token]` URL로 접속한다.
- Then:  
  - 환자명, 병원명, 간병 기간 등 기본 정보가 표시된다.
- 선행 Scenario: WP3.1-1  
- 테스트/검증:  
  - 실제 URL 접속 후 내용 확인.

---

### Scenario WP3.2-2: 잘못된 토큰 접근 실패
- Given:  
  - DB에 존재하지 않는 임의의 token 문자열이 있다.
- When:  
  - `/caregiver/[잘못된token]` URL로 접속한다.
- Then:  
  - “유효하지 않은 링크입니다”와 같은 안내 메시지가 표시된다.
- 선행 Scenario: 없음  
- 테스트/검증:  
  - 랜덤 문자열로 URL 접속 → 에러 메시지 확인.

---

## WP3.3 – 간병인 휴대폰 인증 + 계약 동의

### Scenario WP3.3-1: 간병인 휴대폰 인증 후 계약 동의 성공
- Given:  
  - `/caregiver/[token]` 페이지가 유효하게 열려 있고, 아직 인증되지 않은 상태.
- When:  
  - 간병인의 휴대폰 번호를 입력하고 인증번호를 받은 후, 올바른 코드를 입력하고 [인증 확인] → 계약 내용을 읽고 [내용 확인 및 동의]를 누른다.
- Then:  
  - 인증이 완료되고, DB에 계약 동의 일시가 기록된다.
- 선행 Scenario: WP3.2-1, WP1.1-1  
- 테스트/검증:  
  - UI에서 계약 동의 완료 상태 확인.  
  - 관련 테이블의 agreed_at 값 확인.

---

### Scenario WP3.3-2: 잘못된 인증번호 입력으로 간병인 인증 실패
- Given:  
  - 간병인 휴대폰 번호로 인증번호가 발송된 상태.
- When:  
  - 잘못된 코드를 입력하고 [인증 확인]을 누른다.
- Then:  
  - “인증 실패” 메시지가 표시되고, 계약 동의 화면으로 이동하지 않는다.
- 선행 Scenario: WP3.2-1  
- 테스트/검증:  
  - UI 에러 메시지 확인.  
  - 동의 여부/로그에 변화 없음 확인.

---

## WP3.4 – 간병일지 작성

### Scenario WP3.4-1: 오늘 날짜 일지 작성 성공
- Given:  
  - 유효한 케이스 + 인증된 간병인 계정이 있고, 케이스 상태가 진행 중이다.
- When:  
  - `/caregiver/[token]`에서 오늘 날짜의 일지 내용을 입력하고 [저장] 버튼을 누른다.
- Then:  
  - `care_logs` 테이블에 해당 case_id + 오늘 날짜 row가 생성된다.
- 선행 Scenario: WP3.3-1  
- 테스트/검증:  
  - UI에서 “저장 완료” 확인.  
  - `care_logs` 조회.

---

### Scenario WP3.4-2: 과거 날짜 일지 작성 실패
- Given:  
  - 케이스 시작일이 어제이고, 오늘 날짜 기준으로 UI가 표시된 상태.
- When:  
  - 과거 날짜(어제)를 선택하려 하거나, 해당 날짜로 직접 요청을 보낸다.
- Then:  
  - UI에서 과거 날짜 선택이 비활성화되거나, 서버에서 에러를 반환하여 저장이 되지 않는다.
- 선행 Scenario: WP3.4-1  
- 테스트/검증:  
  - UI 캘린더에서 과거 날짜 클릭 불가 확인.  
  - 강제 API 요청 시 에러 + DB 미생성 확인.

---

### Scenario WP3.4-3: 종료된 케이스에 일지 작성 실패
- Given:  
  - 특정 케이스의 상태가 `ended` 또는 `canceled` 로 설정된 상태.
- When:  
  - `/caregiver/[token]`에서 일지 작성 화면에 접근하거나 저장을 시도한다.
- Then:  
  - “종료된 케이스에는 일지를 작성할 수 없습니다” 등의 메시지가 표시되고 저장되지 않는다.
- 선행 Scenario: WP4.3-2 또는 WP5.4-1  
- 테스트/검증:  
  - UI/서버 응답 확인.  
  - `care_logs`에 새로운 row 미생성 확인.
