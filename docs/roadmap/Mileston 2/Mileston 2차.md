Mileston 2차

# 🧱 간병노트 2차 MVP 개발 Milestones (최종본 v2)

> 전제: 2차 서비스개요 / PRD / 기술스택 / 서비스구조 최종본을 기준으로,  
> 1인 개발자가 Cursor + 외부 콘솔(Supabase/Vercel/Solapi/Gmail/카카오)로 개발한다고 가정.

---

## 📌 전체 Milestone 개요

1. **M0 – 프로젝트 기준선 & 환경 준비**
2. **M1 – 계정/인증/유저 기본 레이어**
3. **M2 – 보호자 플로우 MVP (+ 카카오 템플릿 신청)**
4. **M3 – 간병인 링크 & 일지 플로우 (휴대폰 문자 인증)**
5. **M4 – 운영자 대시보드 & 운영 도구**
6. **M5 – PDF · 이메일 · 카카오 알림 연동 + 통합 테스트**

각 Milestone마다  
- `[Cursor 가능]` : Cursor / 코드 에디터에서 AI에게 시킬 수 있는 일  
- `[사용자 직접]` : 반드시 사람이 콘솔/브라우저/휴대폰으로 직접 해야 하는 일  

을 명확히 구분한다.

---

## M0 – 프로젝트 기준선 & 환경 준비

### 🎯 목표

- 2차 **서비스 개요 / PRD / 기술스택 / 서비스 구조**를 “기준 문서”로 고정.
- Supabase / Vercel / Solapi / Gmail 환경 준비.
- DB 시간대(Timezone)와 `pg_cron` 확장을 한국 서비스에 맞게 설정.

### 🧩 작업

#### ✅ [Cursor 가능]

- Github 레포 구조 점검 및 정리
  - 1차 코드에서 재사용할 부분/정리할 부분 구분
  - `src/app/cases`, `src/app/caregiver`, `src/app/admin` 등 기본 라우트 폴더 생성
- `README.md` 초안 작성
  - 기술 스택 요약
  - Milestones(M0~M5) 요약
  - 필요한 환경 변수 목록 정리  
    (예: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_KEY`, `SOLAPI_KEY`, `GMAIL_USER`, `GMAIL_PASS` 등)
- `.env.example` 파일 작성
  - 실제 값은 비워두고, 키 이름만 정의한 템플릿 파일

#### 🧑‍💻 [사용자 직접]

- **Supabase**
  - 프로젝트 생성(없다면)
  - SQL Editor에서 아래 실행:
    - `ALTER DATABASE postgres SET timezone TO 'Asia/Seoul';`
  - Database → Extensions → `pg_cron` → Enable(활성화)
- **Vercel**
  - Github 레포 연결
  - Production / Preview 배포 파이프라인 설정
- **Solapi**
  - 회원가입
  - 발신번호(본인 휴대폰) 등록 및 승인
- **Gmail**
  - 서류 발송에 사용할 Gmail 계정 1개 선정
  - 앱 비밀번호 생성
- **Git 관리**
  - `.env` 파일이 Git에 올려지지 않도록 `.gitignore` 재확인

### ✅ 완료 기준

- 문서 기준선 확정: “2차 최종 기획”으로 진행.
- Github:
  - `README.md`, `.env.example` 존재.
- Supabase:
  - Timezone이 `Asia/Seoul` 로 설정, `pg_cron` 활성화.
- Solapi / Gmail / Vercel 계정 준비 완료.

---

## M1 – 계정/인증/유저 기본 레이어

### 🎯 목표

- **휴대폰 문자 인증 + 유저/역할 구조**를 먼저 완성.
- 이후 모든 기능은 이 인증/유저 레이어 위에서 동작.

### 🧩 작업

#### ✅ [Cursor 가능]

- **DB 스키마(SQL) 설계**
  - `users`
    - `id`, `auth_email`, `name`, `birth_date`, `contact_email`, `phone`, `phone_verified_at`, `role`, `created_at`, `updated_at`
  - `phone_otps`
    - `phone`, `code_hash`, `expires_at`, `created_at`
- **RLS 1차 설정**
  - 로그인한 사용자만 자신의 `users` 레코드 조회/수정 가능
- **인증 플로우 구현**
  - 휴대폰 번호 입력 → [인증번호 받기]
    - 6자리 인증코드 생성
    - `phone_otps`에 해시+만료시간 저장
    - Solapi API로 문자 발송
  - 인증번호 입력 → [인증 확인]
    - 코드 검증 성공 시:
      - `휴대폰번호@care.local` 형식으로 Supabase Auth 유저 생성/로그인
      - `users` 테이블에 이름/생년월일/이메일/전화번호 저장
- **역할 구조**
  - `users.role`로 `guardian`, `admin` 등 설정
  - `/admin` 접근 시 서버 미들웨어/Route Handler에서 `role='admin'` 체크

#### 🧑‍💻 [사용자 직접]

- Supabase 콘솔에서:
  - Cursor가 만든 테이블/정책 SQL을 SQL Editor에 붙여넣고 실행
- 본인 계정 `users.role`을 `admin`으로 수동 변경 → 운영자 계정 확보
- 실제 문자 인증 테스트:
  - 본인 휴대폰으로 인증번호 수신 및 로그인 확인

### ✅ 완료 기준

- 보호자/운영자 계정 모두 **휴대폰 문자 인증**으로 가입·로그인 가능.
- `users` 테이블에 실제 데이터 저장 확인.
- `/admin` 은 `role='admin'` 인 계정만 접근 가능, 일반 계정은 차단.

---

## M2 – 보호자 플로우 MVP (+ 카카오 템플릿 신청)

### 🎯 목표

- 보호자가 로그인 후 **케이스 생성/조회**가 가능한 기본 흐름 완성.
- 나중에 대기 시간 줄이기 위해, **카카오 알림톡 템플릿을 이 단계에서 미리 신청**.

### 🧩 작업

#### ✅ [Cursor 가능]

- **DB**
  - `cases` 테이블 생성
    - `id`, `guardian_id`, `patient_name`, `hospital_name`, `start_date`, `end_date_planned`, `end_date_final`, `status`, `created_at`, `updated_at`
    - `status` 값 예: `pending`, `active`, `ended`, `ended_early`, `canceled`
  - `cases` RLS:
    - `guardian_id = auth.uid()` 인 row만 보호자가 접근 가능
- **화면 / API**
  - `/cases`
    - 로그인 필요
    - 내 케이스 리스트(카드형)
    - “[새 간병 케이스 만들기]” 버튼
  - 케이스 생성 폼
    - 필드: 환자 이름, 병원명, 시작일, 종료일
    - **zod 검증**:
      - 시작일 ≥ 오늘
      - 종료일 ≥ 시작일
    - 서버에서도 동일 검증(이중 방어)
  - `/cases/[id]`
    - 케이스 상세 정보 표시
    - [연장 요청], [조기 종료 요청] 버튼은 우선 UI 껍데기만 있어도 OK (실제 로직은 M4에서 강화)

#### 🧑‍💻 [사용자 직접]

- **카카오 알림톡 템플릿 신청 (중요)**  
  Solapi / 카카오 비즈 콘솔에서 아래 템플릿 최소 3개 작성 후 검수 신청:
  - 간병 시작 안내
  - 간병인 링크 안내/재발송
  - 간병 종료/서류 발급 안내
- 보호자 UX 직접 확인
  - 에러 메시지, 날짜 선택 UX, 버튼 문구를 실제 고객 기준으로 한 번 더 다듬기

### ✅ 완료 기준

- 보호자가:
  - 로그인 → `/cases` → 새 케이스 생성 → 목록에서 생성된 케이스 확인까지 가능.
- 서로 다른 계정에서:
  - 각자 자신의 케이스만 보임 (RLS 검증).
- 카카오 알림톡 템플릿:
  - 최소 1~2개는 **승인 완료** 또는 **검수 진행 중** 상태.

---

## M3 – 간병인 링크 & 일지 플로우 (휴대폰 문자 인증)

### 🎯 목표

- 보호자가 간병인 참여 링크를 생성해 전달.
- 간병인은 **앱 설치 없이, 링크 + 휴대폰 문자 인증만으로 계약 확인 & 일지 작성** 가능.
- “보호자 번호 뒤 4자리 2차 검증”은 3차 이후 검토(2차 범위에서는 미적용).

### 🧩 작업

#### ✅ [Cursor 가능]

- **DB**
  - `case_tokens`
    - `id`, `case_id`, `token_hash`, `caregiver_phone`, `expired_at`, `created_at`
  - `care_logs`
    - `id`, `case_id`, `date`, `content`, `created_by`, `created_at`
- **보호자 측**
  - `/cases/[id]`
    - “간병인 링크 생성” 버튼
      - 랜덤 토큰 생성
      - DB에는 `token_hash`만 저장, URL에는 원본 토큰 포함
    - 생성된 링크를 복사하는 UI 제공
- **간병인 측**
  - `/caregiver/[token]`
    - 1단계: 토큰 유효성 검증 (존재, 만료 여부)
    - 2단계: 휴대폰 번호 + 문자 인증(6자리 코드)
      - 인증 성공 시 caregiver 역할/세션 부여
    - 계약 요약 화면:
      - 환자명, 병원명, 기간, 주요 조건 요약
      - [내용 확인 및 동의] 버튼
    - 간병일지 입력 화면:
      - 오늘 날짜 기준
      - 체크리스트 + 메모
      - 규칙:
        - 과거 날짜는 작성 불가
        - 종료된 케이스는 작성 불가
- **모바일 UX 고려**
  - 모바일 브라우저 기준 뒤로가기/새로고침 시, 큰 불편이 없도록 최소한의 상태 관리

#### 🧑‍💻 [사용자 직접]

- 실제 시나리오 테스트
  - 보호자 역할: 케이스 생성 + 간병인 링크 생성
  - 간병인 역할: 가족/지인 휴대폰으로 링크 전달 → 문자 인증 → 계약 확인/일지 작성
- 보안 리스크 인지
  - 현재 보안 수준: “토큰 + 간병인 휴대폰 번호 인증”
  - 3차에서 “보호자 번호 뒤 4자리 등 추가 2차 검증”을 넣을 계획이라는 메모 유지

### ✅ 완료 기준

- 보호자가:
  - 케이스 상세에서 간병인 링크 생성/복사 가능.
- 간병인이:
  - 링크 접속 → 휴대폰 문자 인증 → 계약 확인 & 오늘 일지 작성까지 완료.
- 토큰 만료/삭제 시:
  - 해당 링크로 더 이상 접속 불가.

---

## M4 – 운영자 대시보드 & 운영 도구

### 🎯 목표

- 운영자가 `/admin`에서 **전체 케이스를 보고, 문제 케이스(날짜/상태 꼬임 등)를 조정**할 수 있게 만들기.
- 디자인은 최소, 기능 위주로 빠르게 완성.

### 🧩 작업

#### ✅ [Cursor 가능]

- **DB**
  - `activity_logs`
    - `id`, `user_id`, `case_id`, `action`, `meta(jsonb)`, `created_at`
- **화면 & 기능**
  - `/admin/cases`
    - 전체 케이스 테이블
    - 검색:
      - 보호자 이름, 환자 이름, 병원명, 전화번호 일부
    - 필터:
      - 상태(진행중/종료/조기 종료/취소)
      - 기간(시작일 기준)
  - `/admin/cases/[id]`
    - 케이스 상세 정보
    - [강제 종료] 버튼
      - 상태를 `ended_early` 또는 `canceled` 등으로 변경
      - `activity_logs`에 기록
    - [기간 수정] 버튼
      - 과거 포함 자유롭게 수정 가능
      - 변경 전/후를 `activity_logs`에 기록
    - [간병인 링크 재발송] 버튼  
      (실제 카카오 발송은 M5에서 연결)
    - 로그 탭:
      - `activity_logs` 시간순 리스트 표시

#### 🧑‍💻 [사용자 직접]

- 운영 룰 정의
  - 예: “기간 수정은 전화 확인 후만 한다”, “강제 종료 시 메모 필수” 등
- 비정상 데이터 테스트
  - 일부러 기간/상태 꼬인 케이스를 만들어보고,  
    운영자 화면에서 이를 어떻게 조정하는지 연습

### ✅ 완료 기준

- 운영자 계정:
  - `/admin/cases`에서 전체 케이스 조회/검색/필터 가능.
  - `/admin/cases/[id]`에서 강제 종료/기간 수정 후 로그 확인 가능.
- 일반 보호자 계정:
  - `/admin` 전체 경로 접근 시 차단.

---

## M5 – PDF · 이메일 · 카카오 알림 연동 + 통합 테스트

### 🎯 목표

- PDF 생성, 서류 이메일 전송, 카카오 알림톡까지 모두 연결.
- 보호자가 **실제 보험/회사 제출용 서류**를 받을 수 있는 2차 완성본 상태로 만들기.

### 🧩 작업

#### ✅ [Cursor 가능]

- **PDF 생성**
  - `@react-pdf/renderer` 활용
    - 케이스 정보 + 간병일지 요약 → 하나의 PDF 문서 생성
  - `/cases/[id]`에서 “서류 발급하기” 클릭 시 PDF 생성 API 연동
- **이메일 발송**
  - `/api/send-email`
    - 보호자가 입력한 이메일로 PDF 첨부 메일 발송
    - 성공/실패 결과를 `notification_logs`에  
      `channel='email_submit'` 으로 기록
- **카카오 알림톡 연동**
  - Solapi Kakao API 연동 코드 작성
  - M2에서 승인된 템플릿 코드 사용
  - 트리거 예시:
    - 간병 시작일 아침 안내
    - 간병인 링크 발송/재발송
    - 종료/조기 종료 후 “서류 발급 안내”
  - 발송 결과를 `notification_logs`에  
    `channel='kakao_alert'` 로 기록
- **pg_cron 활용**
  - 매일 새벽:
    - 종료일이 지난 케이스들을 `active → ended`로 일괄 변경
    - 필요 시 종료 안내 알림톡 발송 로직 호출

#### 🧑‍💻 [사용자 직접]

- 카카오 템플릿 최종 적용
  - M2에서 검수/승인된 템플릿이 실제로 사용 가능한지 확인
  - 템플릿 ID / 코드 값을 Vercel 환경변수에 설정
- PDF 한글 폰트 준비
  - 나눔고딕, Noto Sans KR 등 TTF 파일을 직접 구해 프로젝트에 포함  
  - 한글이 깨지지 않는지 실제 PDF 출력 테스트
- 실제 E2E 테스트
  - 보호자 계정:
    - 가입 → 케이스 생성 → 간병인 참여 → 일지 작성 → 종료 → 서류 발급 → 이메일 수신
  - 간병인 계정:
    - 링크 접속 → 문자 인증 → 계약/일지 작성
  - 운영자 계정:
    - 이상 케이스 조정 + 알림/이메일 로그 확인

### ✅ 완료 기준

- 보호자가:
  - 2차 범위에서 의도한 전체 플로우(가입 → 케이스 → 간병인 → 일지 → 종료 → 서류 이메일)를 실제로 수행 가능.
- 간병인이:
  - 앱 설치 없이 브라우저만으로 계약 확인 + 일지 작성 가능.
- 운영자가:
  - `/admin`에서 케이스 상태/기간/로그/알림을 확인하고 문제를 정리할 수 있음.

---
