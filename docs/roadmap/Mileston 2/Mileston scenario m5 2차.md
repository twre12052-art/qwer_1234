# M5 – PDF · 이메일 · 카카오 알림 + 통합 시나리오

## WP5.1 – PDF 생성 & 다운로드

### Scenario WP5.1-1: 종료된 케이스 PDF 생성 성공
- Given:  
  - 상태가 `ended`인 케이스가 있고, 일지가 여러 건 등록되어 있다.
- When:  
  - 보호자가 `/cases/[id]`에서 [서류 발급하기] 버튼을 누른다.
- Then:  
  - PDF 파일이 생성되어 브라우저에서 다운로드 된다.
- 선행 Scenario: WP3.4-1, WP4.3-2 또는 WP5.4-1  
- 테스트/검증:  
  - 다운로드된 PDF를 열어 내용(한글, 일지, 케이스 정보) 확인.

---

## WP5.2 – 이메일로 PDF 첨부 발송

### Scenario WP5.2-1: 올바른 이메일로 PDF 발송 성공
- Given:  
  - 종료된 케이스와 유효한 이메일 주소가 있다.
- When:  
  - `/cases/[id]`에서 이메일 주소를 입력하고 [이메일로 받기] 버튼을 누른다.
- Then:  
  - 해당 이메일로 PDF 첨부 메일이 발송되고, `notification_logs`에 성공 기록이 남는다.
- 선행 Scenario: WP5.1-1  
- 테스트/검증:  
  - 실제 메일함에서 메일 수신 + 첨부 확인.  
  - `notification_logs`에서 해당 기록 조회.

---

### Scenario WP5.2-2: 잘못된 이메일 주소로 발송 실패
- Given:  
  - 형식이 잘못된 이메일(예: `abc@`)을 입력한 상태.
- When:  
  - [이메일로 받기] 버튼을 누른다.
- Then:  
  - “잘못된 이메일 형식입니다” 메시지를 표시하고 발송을 진행하지 않는다.
- 선행 Scenario: 없음  
- 테스트/검증:  
  - UI 에러 메시지 확인.  
  - 실제 메일 미수신 및 `notification_logs`에 실패/미기록 확인.

---

## WP5.3 – 카카오 알림톡 발송

### Scenario WP5.3-1: 케이스 시작일 알림톡 발송 성공
- Given:  
  - 시작일이 오늘인 케이스가 있고, 알림톡 템플릿이 승인된 상태이다.
- When:  
  - 시작일 트리거(배치 혹은 서버 로직)가 실행된다.
- Then:  
  - 보호자 휴대폰으로 시작 안내 알림톡이 도착하고, `notification_logs`에 성공 상태가 기록된다.
- 선행 Scenario: WP2.4-1, WP4.1-1  
- 테스트/검증:  
  - 실제 카카오톡 알림 도착 확인.  
  - `notification_logs`에서 해당 row 조회.

---

### Scenario WP5.3-2: 잘못된 번호에 대한 알림톡 발송 실패 기록
- Given:  
  - 형식이 잘못된 번호 또는 실제로 수신이 불가능한 번호가 저장된 케이스가 있다.
- When:  
  - 동일한 시작일/종료일 트리거가 실행된다.
- Then:  
  - 알림톡 발송이 실패하고, `notification_logs`에 실패 상태 및 에러 코드가 기록된다.
- 선행 Scenario: WP5.3-1  
- 테스트/검증:  
  - 알림 미수신 확인.  
  - `notification_logs`에서 status=failed와 에러 정보 확인.

---

## WP5.4 – pg_cron 자동 종료 + E2E

### Scenario WP5.4-1: 자동 종료 스케줄러가 상태 변경 성공
- Given:  
  - `end_date_planned`가 어제인 `status='active'` 케이스가 DB에 있다.
- When:  
  - `pg_cron`에 등록된 Job(매일 새벽)이 실행되거나 수동으로 트리거한다.
- Then:  
  - 해당 케이스의 상태가 `ended`로 변경된다.
- 선행 Scenario: WP0.2-3, WP2.2-1  
- 테스트/검증:  
  - cron 실행 전/후 `cases.status` 비교.

---

### Scenario WP5.4-2: 전체 E2E 시나리오 성공
- Given:  
  - 시스템이 M0~M5 모든 WP 기준으로 구성된 상태.
- When:  
  1. 보호자가 가입/로그인한다.  
  2. 케이스를 생성한다.  
  3. 간병인 링크를 생성하고, 간병인이 링크로 접속하여 인증/계약 동의/일지를 작성한다.  
  4. 기간 도달 또는 Admin 강제 종료로 케이스를 종료 상태로 만든다.  
  5. 보호자가 PDF 발급 및 이메일 전송을 요청한다.  
  6. 카카오 알림톡(시작/링크/종료)이 각각 발송된다.  
  7. Admin이 `/admin/cases/[id]`에서 상태/로그/알림 이력을 확인한다.
- Then:  
  - 각 단계가 끊김 없이 정상적으로 완료되고,  
    DB/로그/알림/PDF가 설계한 대로 동작한다.
- 선행 Scenario:  
  - WP1.1-1, WP2.2-1, WP3.3-1, WP3.4-1, WP4.3-2, WP5.1-1, WP5.2-1, WP5.3-1, WP5.4-1
- 테스트/검증:  
  - 실제 유저 시나리오를 한 번 쭉 따라가며  
    중간에 오류가 없는지 체험 + Supabase/로그/알림/메일/PDF를 모두 점검.
