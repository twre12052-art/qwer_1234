# M5 – PDF · 이메일 · 카카오 알림 + 통합

## 🎯 목표
- 보호자가 실제 제출용 서류를 PDF/이메일로 받고,
- 시작/링크/종료 시점에 카카오 알림이 동작하며,
- 전체 흐름을 처음부터 끝까지 끊김 없이 돌릴 수 있는 상태.

---

## ✅ WP5.1 – PDF 생성 & 다운로드

**목표**  
종료된 케이스에서 PDF 서류를 다운로드할 수 있는 상태.

**작업 내용**
- `@react-pdf/renderer`로 PDF 템플릿:
  - 케이스 기본 정보 + 일지 요약.
  - 한글 폰트(TTF) 포함.
- `/cases/[id]`의 [서류 발급하기] 버튼:
  - 서버에서 PDF 생성 → 브라우저 다운로드 응답.

**완료 & 테스트**
- 종료 케이스에서 PDF 생성 → 다운로드/열기 정상.

---

## ✅ WP5.2 – 이메일로 PDF 첨부 발송

**목표**  
보호자가 이메일 주소를 입력하면, PDF 서류가 메일로 도착하는 상태.

**작업 내용**
- `/api/send-email`:
  - caseId, 수신 이메일 입력.
  - PDF 생성(WP5.1 재사용).
  - Gmail SMTP로 메일 전송(첨부 포함).
  - `notification_logs`에 `channel='email_submit'` 기록.
- `/cases/[id]`:
  - 이메일 입력칸 + [이메일로 받기] 버튼.

**완료 & 테스트**
- 실제 이메일로 테스트:
  - 메일 수신 + PDF 첨부 확인.
- 잘못된 이메일 형식 시 에러 처리.

---

## ✅ WP5.3 – 카카오 알림톡 발송 (시작/링크/종료)

**목표**  
주요 시점에 카카오 알림톡을 발송하고, 발송 기록을 남기는 상태.

**작업 내용**
- Solapi Kakao API 연동:
  - M2에서 승인된 템플릿 ID/코드 사용.
- 발송 트리거:
  - 케이스 시작일 아침 → 시작 안내.
  - 간병인 링크 생성/재발송 → 링크 안내.
  - 종료/조기 종료 시 → 서류 발급 안내.
- `notification_logs`:
  - `channel='kakao_alert'`, 성공/실패 기록.

**완료 & 테스트**
- 실제 번호로 테스트:
  - 시작/링크/종료 상황에서 알림톡이 올바르게 도착하는지 확인.
- 실패 케이스(잘못된 번호 등)에서 로그에 실패 기록이 남는지 확인.

---

## ✅ WP5.4 – pg_cron 자동 종료 + 전체 E2E 리허설

**목표**  
날짜가 지나면 케이스가 자동 종료되고,  
보호자–간병인–운영자까지 전체 플로우를 실제처럼 돌릴 수 있는 상태.

**작업 내용**
- Supabase `pg_cron` Job:
  - 매일 새벽:
    - `end_date_planned < 오늘` & `status='active'` → `status='ended'` 업데이트.
  - 필요 시 자동 종료 알림톡과 연동.
- E2E 시나리오:
  1. 보호자 가입/로그인.
  2. 케이스 생성.
  3. 간병인 링크 생성 → 간병인 인증/계약 동의/오늘 일지 작성.
  4. 종료일 도달(or 강제 종료) → 자동/수동 종료.
  5. 서류 발급(PDF 다운로드 + 이메일 전송).
  6. 카카오 알림 수신.
  7. 운영자(Admin) 화면에서 상태/로그/알림 기록 확인.

**완료 & 테스트**
- 종료일을 어제로 설정된 케이스를 만들어  
  cron을 수동/대기 실행 후 `status='ended'`로 바뀌는지 확인.
- E2E 시나리오를 실제로 한 번 쭉 실행:
  - 중간에 막히는 곳 없이 끝까지 진행되면 2차 MVP 완주 성공.
