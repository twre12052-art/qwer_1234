# 🤖 프로젝트 개발 가이드 (Agents & Developers)

이 문서는 `docs/core`의 핵심 내용을 요약하여, 프로젝트에 처음 참여하는 개발자나 AI 에이전트가 빠르게 맥락을 파악하고 개발에 착수할 수 있도록 돕는 가이드입니다.

---

## 1. 프로젝트 개요 (Service Overview)

**간병노트(가칭)**는 가족·지인 간병 시 **보험 청구용 서류(계약서, 일지, 지급확인서)**를 쉽게 생성해주는 웹 서비스입니다.

*   **목표**: 복잡한 서류 작업을 자동화하여 간병인과 보호자의 부담을 줄임.
*   **핵심 흐름**: `보호자 입력` → `간병인 동의` → `매일 일지 작성` → `PDF 자동 생성`

---

## 2. 기술 스택 (Tech Stack)

*   **Framework**: **Next.js 14+ (App Router)**
*   **Language**: TypeScript
*   **Styling**: Tailwind CSS
*   **Database & Auth**: **Supabase** (PostgreSQL, Auth)
*   **State/Logic**: Next.js **Server Actions** (백엔드 API 별도 없음)
*   **PDF**: `@react-pdf/renderer`
*   **Testing**: Playwright (E2E)

---

## 3. 폴더 구조 (Directory Structure)

기능 단위로 모듈화된 구조를 따릅니다.

```text
src/
├── app/                 # Next.js App Router (페이지, 레이아웃)
│   ├── login/           # 로그인 페이지
│   ├── cases/           # 보호자용 케이스 관리
│   ├── caregiver/       # 간병인용 (토큰 접속)
│   └── api/             # Route Handlers (PDF 다운로드 등)
├── modules/             # 비즈니스 로직 (도메인별 분리)
│   ├── auth/            # 인증 (actions.ts)
│   ├── case/            # 케이스 관리 (actions.ts)
│   ├── careLog/         # 간병일지 (actions.ts)
│   ├── payment/         # 결제 정보 (actions.ts)
│   ├── pdf/             # PDF 생성 로직 및 컴포넌트
│   └── shared/          # 공통 유틸, 컴포넌트, 타입
│       ├── lib/         # supabase client 등
│       └── types/       # DB 타입 정의
└── middleware.ts        # 라우트 보호 및 리다이렉션
```

---

## 4. 데이터베이스 구조 (Database)

주요 테이블과 역할은 다음과 같습니다.

*   **`users`**: 보호자 정보 (Supabase Auth와 연동).
*   **`cases`**: 간병 건 정보 (환자, 기간, 금액, 상태 등).
*   **`care_logs`**: 매일 작성되는 간병 일지.
*   **`payments`**: 간병비 지급 정보 (앱 내 결제 없음, 정보만 저장).
*   **`case_tokens`**: 간병인 접속용 고유 링크 토큰.

---

## 5. 주요 개발 규칙 (Development Rules)

### A. 서버 액션 중심 (Server Actions First)
*   데이터를 조회(`GET`)하거나 수정(`POST`)할 때는 **Server Actions**를 최우선으로 사용합니다.
*   `src/modules/{도메인}/actions.ts`에 로직을 작성하고 컴포넌트에서 import하여 사용합니다.

### B. 인증 정책 (Authentication)
*   **보호자**: 이메일/비밀번호 로그인 필수. (`middleware.ts`에서 `/cases` 경로 보호)
*   **간병인**: 별도 회원가입 없음. **URL 토큰**을 통해 접근 및 인증 처리.

### C. 날짜 및 데이터 처리
*   날짜는 `YYYY-MM-DD` 문자열 형식을 기준으로 처리하여 타임존 이슈를 방지합니다.
*   데이터베이스 타입은 `src/modules/shared/types/db.ts`를 참조합니다.

### D. 테스트 (Testing)
*   주요 기능 변경 시 `npm run test:e2e`를 통해 시나리오 테스트를 수행합니다.

---

## 6. 핵심 비즈니스 로직 (Core Flows)

개발 시 다음 흐름을 준수해야 합니다.

1.  **케이스 생성**: 보호자가 환자/간병인 정보를 입력하면 `GUARDIAN_PENDING` 상태로 생성.
2.  **계약 동의**: 보호자가 먼저 동의 → 간병인에게 링크 전달 → 간병인이 링크 접속 후 동의 (`IN_PROGRESS`로 변경).
3.  **일지 작성**: 간병인은 매일 일지작성을 권장하며 간병이 끝나는 마지막 날까지 작성해야 함 (미작성 시 보호자가 작성 가능).
4.  **기간 변경**: '조기 종료' 또는 '기간 연장'은 보호자만 가능하며, 변경 시 간병인 동의(알림) 절차가 필요함.
5.  **PDF 생성**: 모든 일지가 작성되고 지급 정보가 입력되면 PDF 다운로드 가능.

---

## 7. 작업 규칙 (Work Process)

### 🎯 작업 전 준비
*   **목적 먼저 확인**: 코드를 작성하기 전에 `docs/roadmap`에서 해당 단계의 **목적**과 **시나리오**를 먼저 읽고 이해하세요.
*   **서비스의 본질 생각하기**: "이 기능은 왜 필요한가?", "사용자에게 어떤 가치를 주는가?"를 항상 고민하며 작업하세요.

### 📝 코드 작성 시
*   **작은 단위로 작업**: 한 번에 너무 많은 코드를 작성하지 말고, 하나의 기능이나 화면 단위로 나눠서 작업하세요.
*   **기존 코드 먼저 확인**: 기존 파일을 수정할 때는 먼저 해당 파일을 읽고 현재 동작 방식을 파악한 후 수정하세요.
*   **일관성 유지**: 같은 도메인의 다른 파일(`actions.ts`, 페이지 등)과 패턴을 맞추세요.

### 🐛 에러 발생 시
*   **원인 분석 우선**: 에러가 발생하면 급하게 수정하지 말고, 에러 메시지와 스택 트레이스를 확인하여 원인을 먼저 파악하세요.
*   **설명 후 수정**: 원인을 간단히 설명한 뒤, 그에 맞는 수정을 진행하세요.
*   **린터 확인**: 코드 수정 후 `read_lints` 도구로 새로운 에러가 없는지 확인하세요.

### ✅ 작업 완료 후
*   **테스트 필수**: 작성이 끝나면 **반드시** 해당 코드가 의도한 대로 동작하는지 테스트를 실행하세요.
    *   개발 서버(`npm run dev`)를 실행하고 브라우저에서 직접 확인.
    *   E2E 테스트(`npm run test:e2e`)를 통해 시나리오 검증.
*   **문서 업데이트**: 새로운 API나 중요한 로직을 추가했다면 `agents.md`나 관련 문서를 업데이트하세요.

### 💡 기타 유의사항
*   **환경 변수 관리**: `.env.local` 파일 수정 후에는 **서버 재시작** 필수.
*   **커밋 전 체크리스트**:
    1.  린터 에러 없음
    2.  테스트 통과
    3.  불필요한 콘솔 로그 제거
    4.  주석 정리 (과도한 주석 제거, 필요한 설명만 유지)
*   **처음 개발하는 사람 관점**: 코드를 작성할 때 "3개월 후 나", 또는 "처음 이 프로젝트를 보는 사람"이 이해할 수 있는지 생각하며 작성하세요.

